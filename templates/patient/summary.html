{% extends 'base.html' %}

{% block title %}Session Summary - Home Rehab Coach{% endblock %}

{% block header %}
<header class="header">
    <h1><a href="{{ url_for('patient_dashboard') }}">üè† Home Rehab Coach</a></h1>
    <nav class="nav-links">
        <a href="{{ url_for('patient_dashboard') }}">Dashboard</a>
        <a href="{{ url_for('patient_appointments') }}">Consultations</a>
        <div class="nav-user">
            <button class="nav-user-btn" title="Account">ÔøΩÔøΩ</button>
            <div class="nav-user-dropdown">
                <div class="nav-user-dropdown-inner">
                    <div class="dropdown-header">Signed in as<strong>{{ user.name if user else 'Patient' }}</strong></div>
                    <a href="{{ url_for('patient_profile') }}"><span class="dropdown-icon">ÔøΩ</span> My Profile</a>
                    <div class="dropdown-divider"></div>
                    <a href="{{ url_for('logout') }}" class="dropdown-logout"><span class="dropdown-icon">üö™</span> Logout</a>
                </div>
            </div>
        </div>
    </nav>
</header>
{% endblock %}

{% block content %}
<style>
    .summary-container { max-width: 820px; margin: 30px auto; padding: 0 16px; }
    .summary-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #fff; border-radius: 14px; padding: 30px 34px; margin-bottom: 24px;
        display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;
    }
    .summary-header h2 { margin: 0; font-size: 1.5rem; }
    .summary-header .meta { font-size: .9rem; opacity: .85; margin-top: 4px; }
    .overall-badge {
        font-size: 2.2rem; font-weight: 800; background: rgba(255,255,255,.2);
        padding: 14px 22px; border-radius: 12px; text-align: center; line-height: 1;
    }
    .overall-badge small { display: block; font-size: .7rem; font-weight: 400; margin-top: 4px; }

    /* Stat cards row */
    .stat-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 14px; margin-bottom: 24px; }
    .stat-card {
        background: #fff; border-radius: 12px; padding: 18px; text-align: center;
        box-shadow: 0 2px 12px rgba(0,0,0,.06);
    }
    .stat-card .stat-icon { font-size: 1.6rem; margin-bottom: 6px; }
    .stat-card .stat-value { font-size: 1.4rem; font-weight: 700; color: #333; }
    .stat-card .stat-label { font-size: .8rem; color: #888; margin-top: 2px; }

    /* Exercise breakdown */
    .exercise-table {
        width: 100%; border-collapse: collapse; background: #fff;
        border-radius: 12px; overflow: hidden; box-shadow: 0 2px 12px rgba(0,0,0,.06);
        margin-bottom: 24px;
    }
    .exercise-table th {
        background: #f0f2f5; text-align: left; padding: 12px 16px; font-size: .85rem;
        color: #555; text-transform: uppercase; letter-spacing: .5px;
    }
    .exercise-table td { padding: 14px 16px; border-top: 1px solid #eee; font-size: .92rem; }
    .exercise-table tr:hover td { background: #f9faff; }
    .perc-bar { display: inline-block; height: 8px; border-radius: 4px; vertical-align: middle; margin-right: 6px; }
    .perc-bar.full  { background: #28a745; }
    .perc-bar.half  { background: #ffc107; }
    .perc-bar.low   { background: #dc3545; }

    /* Actions */
    .action-row { display: flex; gap: 14px; flex-wrap: wrap; justify-content: center; }
    .action-btn {
        padding: 14px 28px; font-size: 1rem; font-weight: 600; border: none; border-radius: 10px;
        cursor: pointer; transition: .2s; text-decoration: none; text-align: center;
    }
    .action-btn:hover { transform: translateY(-1px); }
    .action-primary { background: linear-gradient(135deg,#007bff,#0056d2); color: #fff; }
    .action-secondary { background: #e9ecef; color: #333; }
    .action-success { background: linear-gradient(135deg,#28a745,#20c997); color: #fff; }
</style>

<div class="summary-container">

    {% if session_data %}
    <!-- Header -->
    <div class="summary-header">
        <div>
            <h2>Session Summary üéØ</h2>
            <div class="meta">
                {% if session_data.started_at %}
                {{ session_data.started_at[:16] | replace('T', ' ') }}
                {% endif %}
                {% if overall_duration %}
                  ¬∑ {{ (overall_duration // 60) }}m {{ overall_duration % 60 }}s total
                {% endif %}
            </div>
        </div>
        <div class="overall-badge">
            {{ session_data.completed_perc | default(0) | round(0) | int }}%
            <small>completed</small>
        </div>
    </div>

    <!-- Stat cards -->
    <div class="stat-row">
        <div class="stat-card">
            <div class="stat-icon">üéØ</div>
            <div class="stat-value">{{ session_data.quality_score | default(0) | round(1) }}</div>
            <div class="stat-label">Quality Score</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üò£</div>
            <div class="stat-value">{{ session_data.pain_before | default(0) }} ‚Üí {{ session_data.pain_after | default(0) }}</div>
            <div class="stat-label">Pain (Before ‚Üí After)</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üí™</div>
            <div class="stat-value">{{ session_data.effort_level | default(5) }} / 10</div>
            <div class="stat-label">Effort Level</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">‚è±Ô∏è</div>
            <div class="stat-value">
                {% if overall_duration %}{{ (overall_duration // 60) }}:{{ '%02d' | format(overall_duration % 60) }}{% else %}--{% endif %}
            </div>
            <div class="stat-label">Duration</div>
        </div>
    </div>

    <!-- Exercise breakdown table -->
    {% if exercises %}
    <table class="exercise-table">
        <thead>
            <tr>
                <th>Exercise</th>
                <th>Quality</th>
                <th>Completion</th>
                <th>Sets (Done / Target)</th>
                <th>Time</th>
            </tr>
        </thead>
        <tbody>
            {% for ex in exercises %}
            <tr>
                <td><strong>{{ ex.exercise_name }}</strong></td>
                <td>{{ ex.quality_score | default(0) }}</td>
                <td>
                    {% set perc = ex.completion_perc | default(0) %}
                    <span class="perc-bar {% if perc >= 100 %}full{% elif perc >= 50 %}half{% else %}low{% endif %}"
                          style="width: {{ [perc, 100] | min }}px;"></span>
                    {{ perc }}%
                </td>
                <td>
                    {% set done = ex.sets_completed.values() | list | length %}
                    {% set total = ex.sets_required.values() | list | length %}
                    {{ done }} / {{ total }}
                </td>
                <td>
                    {% if ex.duration_seconds %}
                    {{ (ex.duration_seconds // 60) }}:{{ '%02d' | format(ex.duration_seconds % 60) }}
                    {% else %}
                    --
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}

    <!-- Action buttons ‚Äî conditional on completion -->
    <div class="action-row">
        {% set completion = session_data.completed_perc | default(0) %}
        {% if completion < 100 %}
            <a href="{{ url_for('rehab_session') }}" class="action-btn action-primary">üîÑ Restart Session</a>
            <a href="{{ url_for('rehab_session') }}" class="action-btn action-success">‚ñ∂Ô∏è Start From Where You Left</a>
            <a href="{{ url_for('patient_dashboard') }}" class="action-btn action-secondary">üè† Go to Dashboard</a>
        {% else %}
            <a href="{{ url_for('rehab_session') }}" class="action-btn action-primary">üîÑ Restart Session</a>
            <a href="{{ url_for('patient_dashboard') }}" class="action-btn action-secondary">üè† Go to Dashboard</a>
        {% endif %}
    </div>

    {% else %}
    <!-- No session data -->
    <div style="text-align:center; padding:60px 20px;">
        <div style="font-size:3rem;margin-bottom:16px;">üìã</div>
        <h2>No Session Data</h2>
        <p style="color:#666;">Complete a session to see your summary here.</p>
        <a href="{{ url_for('rehab_session') }}" class="action-btn action-primary" style="display:inline-block;margin-top:16px;">Start a Session</a>
    </div>
    {% endif %}

</div>
{% endblock %}
