{% extends 'base.html' %}

{% block title %}My Profile - Home Rehab Coach{% endblock %}

{% block header %}
<header class="header">
    <h1><a href="{{ url_for('patient_dashboard') }}"><img src="{{ url_for('static', filename='rehab-logo.png') }}" alt="Home Rehab Coach logo" class="brand-logo"> Home Rehab Coach</a></h1>
    <nav class="nav-links">
        <a href="{{ url_for('patient_dashboard') }}">Dashboard</a>
        <a href="{{ url_for('patient_appointments') }}">Consultations</a>
        <div class="nav-user">
            <button class="nav-user-btn" title="Account"><i class="fa-solid fa-user"></i></button>
            <div class="nav-user-dropdown">
                <div class="nav-user-dropdown-inner">
                    <div class="dropdown-header">Signed in as<strong>{{ user.name }}</strong></div>
                    <a href="{{ url_for('patient_profile') }}" class="active"><span class="dropdown-icon"><i class="fa-solid fa-user"></i></span> My Profile</a>
                    <div class="dropdown-divider"></div>
                    <a href="{{ url_for('logout') }}" class="dropdown-logout"><span class="dropdown-icon"><i class="fa-solid fa-right-from-bracket"></i></span> Logout</a>
                </div>
            </div>
        </div>
    </nav>
</header>
{% endblock %}

{% block content %}
<style>
    .profile-layout {
        display: flex;
        gap: 28px;
        margin-top: 10px;
        min-height: 70vh;
    }

    /* ── Left sidebar ── */
    .profile-sidebar {
        width: 220px;
        flex-shrink: 0;
        background: #fff;
        border-radius: 14px;
        box-shadow: 0 2px 12px rgba(0,0,0,.07);
        padding: 20px 0;
        align-self: flex-start;
        position: sticky;
        top: 90px;
    }
    .profile-sidebar h3 {
        font-size: .85rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: #999;
        padding: 0 20px;
        margin: 0 0 12px;
    }
    .profile-sidebar a {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 24px;
        color: #333;
        text-decoration: none;
        font-weight: 500;
        font-size: .95rem;
        transition: background .15s, color .15s;
        border-left: 3px solid transparent;
    }
    .profile-sidebar a:hover {
        background: #f4f6fa;
        color: #1a73e8;
    }
    .profile-sidebar a.active {
        background: #eef3ff;
        color: #1a73e8;
        border-left-color: #1a73e8;
        font-weight: 600;
    }
    .profile-sidebar .sidebar-icon {
        font-size: 1.15rem;
    }

    /* ── Right content area ── */
    .profile-content {
        flex: 1;
        min-width: 0;
    }

    .profile-page-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1a1a2e;
        margin: 0 0 24px;
    }

    /* ── Info cards ── */
    .info-card {
        background: #fff;
        border-radius: 14px;
        box-shadow: 0 2px 12px rgba(0,0,0,.07);
        padding: 28px 32px;
        margin-bottom: 24px;
    }
    .info-card-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: #1a1a2e;
        margin: 0 0 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .info-card-title .card-icon {
        font-size: 1.3rem;
    }

    .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 18px 40px;
    }
    .info-item {
        display: flex;
        flex-direction: column;
        gap: 3px;
    }
    .info-label {
        font-size: .78rem;
        text-transform: uppercase;
        letter-spacing: .8px;
        color: #888;
        font-weight: 600;
    }
    .info-value {
        font-size: 1rem;
        color: #1a1a2e;
        font-weight: 500;
    }
    .info-value.role-badge {
        display: inline-block;
        background: #eef3ff;
        color: #1a73e8;
        padding: 2px 14px;
        border-radius: 20px;
        font-size: .85rem;
        font-weight: 600;
        width: fit-content;
    }

    /* ── Care team cards ── */
    .care-team-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }
    .care-person-card {
        background: #f8f9fc;
        border-radius: 12px;
        padding: 22px 24px;
        border: 1px solid #e8ebf0;
    }
    .care-person-card .cp-role {
        font-size: .75rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 700;
        margin: 0 0 10px;
    }
    .care-person-card.doctor .cp-role { color: #1a73e8; }
    .care-person-card.caregiver .cp-role { color: #28a745; }
    .care-person-card .cp-name {
        font-size: 1.1rem;
        font-weight: 700;
        color: #1a1a2e;
        margin: 0 0 8px;
    }
    .care-person-card .cp-detail {
        font-size: .88rem;
        color: #555;
        margin: 4px 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .care-person-card .cp-detail .cp-icon { font-size: .95rem; }

    .no-assignment {
        color: #999;
        font-style: italic;
        font-size: .92rem;
        padding: 16px 0;
    }

    /* ── Responsive ── */
    @media (max-width: 768px) {
        .profile-layout {
            flex-direction: column;
            gap: 16px;
        }
        .profile-sidebar {
            width: 100%;
            position: static;
            display: flex;
            flex-direction: row;
            padding: 0;
            border-radius: 12px;
            overflow-x: auto;
        }
        .profile-sidebar h3 { display: none; }
        .profile-sidebar a {
            border-left: none;
            border-bottom: 3px solid transparent;
            padding: 14px 20px;
            white-space: nowrap;
            font-size: .9rem;
        }
        .profile-sidebar a.active {
            border-bottom-color: #1a73e8;
            border-left-color: transparent;
        }
        .info-grid,
        .care-team-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="profile-layout">
    <!-- Left Sidebar Navigation -->
    <nav class="profile-sidebar">
        <h3>Profile</h3>
        <a href="{{ url_for('patient_profile') }}" class="active">
            <span class="sidebar-icon"><i class="fa-solid fa-user"></i></span> Personal Details
        </a>
        <a href="{{ url_for('progress_history') }}">
            <span class="sidebar-icon"><i class="fa-solid fa-chart-line"></i></span> Your Progress
        </a>
    </nav>

    <!-- Right Content -->
    <div class="profile-content">
        <h2 class="profile-page-title">Personal Details</h2>

        <!-- User Information -->
        <div class="info-card">
            <div class="info-card-title" style="justify-content: space-between;">
                <span><span class="card-icon"><i class="fa-solid fa-id-card"></i></span> Account Information</span>
                <button class="btn-edit-profile" onclick="toggleEditMode()" id="editProfileBtn">
                    <i class="fa-solid fa-pen"></i> Edit
                </button>
            </div>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Full Name</span>
                    <span class="info-value">{{ user_info.name }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Email Address</span>
                    <span class="info-value info-display" data-field="email">{{ user_info.email }}</span>
                    <input type="email" class="info-edit-input" data-field="email" value="{{ user_info.email }}" style="display:none;">
                </div>
                <div class="info-item">
                    <span class="info-label">Role</span>
                    <span class="info-value role-badge">{{ user_info.role|capitalize }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Phone</span>
                    <span class="info-value info-display" data-field="phone">{{ user_info.phone if user_info.phone else '— Not set' }}</span>
                    <input type="tel" class="info-edit-input" data-field="phone" value="{{ user_info.phone or '' }}" placeholder="e.g. +91 98765 43210" style="display:none;">
                </div>
                <div class="info-item">
                    <span class="info-label">Pincode</span>
                    <span class="info-value info-display" data-field="pincode">{{ user_info.pincode if user_info.pincode else '— Not set' }}</span>
                    <input type="text" class="info-edit-input" data-field="pincode" value="{{ user_info.pincode or '' }}" placeholder="e.g. 600001" style="display:none;">
                </div>
                <div class="info-item">
                    <span class="info-label">Date of Birth</span>
                    <span class="info-value">{{ user_info.dob if user_info.dob else '—' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Age</span>
                    <span class="info-value">{{ (age|string + ' years') if age else '—' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Member Since</span>
                    <span class="info-value">
                        {% if user_info.created_at %}
                            {{ user_info.created_at[:10] }}
                        {% else %}
                            —
                        {% endif %}
                    </span>
                </div>
                {% if patient %}
                <div class="info-item">
                    <span class="info-label">Condition</span>
                    <span class="info-value">{{ patient.condition }}</span>
                </div>
                {% endif %}
            </div>
            <!-- Save / Cancel buttons (hidden by default) -->
            <div class="edit-actions" id="editActions" style="display:none; margin-top:20px; padding-top:18px; border-top:1px solid #e8ebf0; display:none;">
                <button class="btn btn-primary" onclick="saveProfile()" style="padding:10px 24px; font-weight:600;">
                    <i class="fa-solid fa-check"></i> Save Changes
                </button>
                <button class="btn" onclick="cancelEdit()" style="padding:10px 24px; margin-left:10px;">
                    Cancel
                </button>
                <span id="editStatus" style="margin-left:15px; font-size:.9rem;"></span>
            </div>
        </div>

        <!-- Care Team -->
        <div class="info-card">
            <div class="info-card-title">
                <span class="card-icon"><i class="fa-solid fa-stethoscope"></i></span> Your Care Team
            </div>
            <div class="care-team-grid">
                <!-- Doctor -->
                <div class="care-person-card doctor">
                    <div class="cp-role">Assigned Doctor</div>
                    {% if doctor %}
                        <div class="cp-name">{{ doctor.name }}</div>
                        <div class="cp-detail">
                            <span class="cp-icon">✉️</span> {{ doctor.email }}
                        </div>
                        {% if doctor.phone %}
                        <div class="cp-detail">
                            <span class="cp-icon"><i class="fa-solid fa-phone"></i></span> {{ doctor.phone }}
                        </div>
                        {% endif %}
                        <div class="cp-detail">
                            <span class="cp-icon"><i class="fa-solid fa-calendar-days"></i></span> Since {{ doctor.assigned_date }}
                        </div>
                    {% else %}
                        <p class="no-assignment">No doctor assigned yet</p>
                    {% endif %}
                </div>

                <!-- Caregiver -->
                <div class="care-person-card caregiver">
                    <div class="cp-role">Assigned Caregiver</div>
                    {% if caregiver %}
                        <div class="cp-name">{{ caregiver.name }}</div>
                        <div class="cp-detail">
                            <span class="cp-icon">✉️</span> {{ caregiver.email }}
                        </div>
                        {% if caregiver.phone %}
                        <div class="cp-detail">
                            <span class="cp-icon"><i class="fa-solid fa-phone"></i></span> {{ caregiver.phone }}
                        </div>
                        {% endif %}
                        {% if caregiver.relationship %}
                        <div class="cp-detail">
                            <span class="cp-icon"><i class="fa-solid fa-handshake"></i></span> {{ caregiver.relationship }}
                        </div>
                        {% endif %}
                    {% else %}
                        <p class="no-assignment">No caregiver assigned yet</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Appointment Preferences -->
        <div class="info-card">
            <div class="info-card-title">
                <span class="card-icon"><i class="fa-solid fa-sliders"></i></span> Appointment Preferences
            </div>
            {% if patient %}
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Appointment Urgency</span>
                    <span class="info-value">
                        {{ patient.urgency if patient.urgency else 'Medium' }}
                        {% if patient.urgency == 'High' %}<i class="fa-solid fa-circle" style="color: #dc2626;"></i>{% elif patient.urgency == 'Medium' %}<i class="fa-solid fa-circle" style="color: #f59e0b;"></i>{% else %}<i class="fa-solid fa-circle" style="color: #22c55e;"></i>{% endif %}
                    </span>
                </div>
                <div class="info-item">
                    <span class="info-label">Maximum Travel Distance</span>
                    <span class="info-value">
                        {{ patient.max_distance if patient.max_distance else '20' }} km
                    </span>
                </div>
                <div class="info-item">
                    <span class="info-label">Pincode / Postal Code</span>
                    <span class="info-value">{{ patient.address if patient.address else '—  Not set' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Specialty Needed</span>
                    <span class="info-value">{{ patient.specialty_needed if patient.specialty_needed else 'General' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Preferred Doctor</span>
                    <span class="info-value">
                        {% if doctor %}
                            {{ doctor.name }}
                        {% else %}
                            —  Auto-assigned
                        {% endif %}
                    </span>
                </div>
                <div class="info-item">
                    <span class="info-label">Current Rehab Score</span>
                    <span class="info-value">
                        {{ patient.avg_quality_score if patient.avg_quality_score else '—' }}/10
                        {% if patient.avg_quality_score %}
                            {% if patient.avg_quality_score < 3 %}<i class="fa-solid fa-triangle-exclamation" style="color: #dc2626;"></i>{% elif patient.avg_quality_score < 5 %}<i class="fa-solid fa-triangle-exclamation" style="color: #f59e0b;"></i>{% else %}<i class="fa-solid fa-circle-check" style="color: #22c55e;"></i>{% endif %}
                        {% endif %}
                    </span>
                </div>
            </div>
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e8ebf0;">
                <a href="{{ url_for('patient_appointments') }}" class="btn btn-primary" style="text-decoration: none; display: inline-block; padding: 10px 20px; background: #1a73e8; color: white; border-radius: 6px; font-weight: 600;">
                    <i class="fa-solid fa-pen-to-square"></i> Edit Preferences
                </a>
                <small style="color: #666; margin-left: 15px;">Update your scheduling preferences on the Appointments page</small>
            </div>
            {% else %}
            <p class="no-assignment">Patient profile not found</p>
            {% endif %}
        </div>

    </div>
</div>

<style>
.btn-edit-profile {
    background: #f0f4ff; color: #1a73e8; border: 1px solid #c4d7f5;
    padding: 7px 18px; border-radius: 8px; cursor: pointer; font-size: .88rem;
    font-weight: 600; transition: all .2s;
}
.btn-edit-profile:hover { background: #1a73e8; color: #fff; }
.info-edit-input {
    width: 100%; padding: 9px 12px; border: 1.5px solid #1a73e8; border-radius: 8px;
    font-size: .95rem; font-family: inherit; outline: none; background: #f7f9fc;
    transition: border-color .2s;
}
.info-edit-input:focus { border-color: #0d47a1; background: #fff; }
.edit-actions .btn-primary { background: #1a73e8; color: #fff; border: none; border-radius: 8px; cursor: pointer; }
.edit-actions .btn-primary:hover { background: #1558b0; }
.edit-actions .btn { background: #f0f0f0; color: #333; border: none; border-radius: 8px; cursor: pointer; }
.edit-actions .btn:hover { background: #e0e0e0; }
</style>

<script>
let editMode = false;

function toggleEditMode() {
    editMode = !editMode;
    const displays = document.querySelectorAll('.info-display');
    const inputs   = document.querySelectorAll('.info-edit-input');
    const actions  = document.getElementById('editActions');
    const btn      = document.getElementById('editProfileBtn');

    displays.forEach(el => el.style.display = editMode ? 'none' : '');
    inputs.forEach(el   => el.style.display = editMode ? 'block' : 'none');
    actions.style.display = editMode ? 'flex' : 'none';
    btn.innerHTML = editMode
        ? '<i class="fa-solid fa-xmark"></i> Cancel'
        : '<i class="fa-solid fa-pen"></i> Edit';
}

function cancelEdit() {
    // reset inputs to original values
    document.querySelectorAll('.info-edit-input').forEach(inp => {
        const field = inp.dataset.field;
        const display = document.querySelector(`.info-display[data-field="${field}"]`);
        const origVal = display.textContent.trim();
        inp.value = origVal.startsWith('—') ? '' : origVal;
    });
    toggleEditMode();
}

async function saveProfile() {
    const status = document.getElementById('editStatus');
    status.textContent = 'Saving…';
    status.style.color = '#1a73e8';

    const body = {};
    document.querySelectorAll('.info-edit-input').forEach(inp => {
        body[inp.dataset.field] = inp.value.trim();
    });

    try {
        const res = await fetch('/api/profile/update', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(body)
        });
        const data = await res.json();
        if (data.success) {
            status.textContent = '✓ Saved';
            status.style.color = '#22c55e';
            // update display spans
            document.querySelectorAll('.info-edit-input').forEach(inp => {
                const field = inp.dataset.field;
                const display = document.querySelector(`.info-display[data-field="${field}"]`);
                display.textContent = inp.value.trim() || '— Not set';
            });
            setTimeout(() => toggleEditMode(), 800);
        } else {
            status.textContent = data.error || 'Error saving';
            status.style.color = '#dc2626';
        }
    } catch (e) {
        status.textContent = 'Network error';
        status.style.color = '#dc2626';
    }
}
</script>
{% endblock %}
