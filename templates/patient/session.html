{% extends 'base.html' %}

{% block title %}Rehab Session - Home Rehab Coach{% endblock %}

{% block header %}
<header class="header">
    <h1>üèãÔ∏è Rehab Session</h1>
    <nav class="nav-links">
        <a href="{{ url_for('patient_dashboard') }}">‚Üê Back to Dashboard</a>
    </nav>
</header>
{% endblock %}

{% block content %}
<style>
    /* Form Status Styles */
    .form-status {
        text-align: center;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 15px;
    }
    
    .form-status .badge {
        display: inline-block;
        padding: 10px 20px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 1rem;
        margin-bottom: 10px;
    }
    
    .form-status .badge.correct {
        background: #d4edda;
        color: #155724;
        border: 2px solid #28a745;
    }
    
    .form-status .badge.incorrect {
        background: #f8d7da;
        color: #721c24;
        border: 2px solid #dc3545;
        animation: pulse-warning 1s infinite;
    }
    
    .form-status .badge.analyzing {
        background: #fff3cd;
        color: #856404;
        border: 2px solid #ffc107;
    }
    
    @keyframes pulse-warning {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
    
    .form-status .score {
        font-size: 1.2rem;
        color: #333;
        font-weight: 600;
    }
    
    /* Realtime Feedback List */
    .realtime-feedback {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #e0e0e0;
    }
    
    .realtime-feedback h4 {
        margin: 0 0 10px 0;
        color: #333;
        font-size: 0.9rem;
    }
    
    .feedback-item {
        padding: 8px 12px;
        margin-bottom: 8px;
        border-radius: 6px;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 8px;
        animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
        from { opacity: 0; transform: translateX(-10px); }
        to { opacity: 1; transform: translateX(0); }
    }
    
    .feedback-item.warning {
        background: #fff3cd;
        border-left: 3px solid #ffc107;
        color: #856404;
    }
    
    .feedback-item.error {
        background: #f8d7da;
        border-left: 3px solid #dc3545;
        color: #721c24;
    }
    
    .feedback-item.success {
        background: #d4edda;
        border-left: 3px solid #28a745;
        color: #155724;
    }
    
    .feedback-item.info {
        background: #d1ecf1;
        border-left: 3px solid #17a2b8;
        color: #0c5460;
    }
    
    /* Video container for webcam */
    .video-container {
        position: relative;
        width: 100%;
        background: #1a1a2e;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .video-container video {
        width: 100%;
        height: auto;
        display: block;
    }
    
    .video-container canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
        50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
    }
    
    .exercise-step {
        transition: background 0.3s, color 0.3s;
    }
    
    #nextExerciseBtn {
        font-size: 1rem;
        font-weight: bold;
        padding: 12px;
        margin-top: 8px;
    }
</style>

<div class="session-layout">
    <!-- Video Panel -->
    <div class="video-panel">
        <div class="skeleton-overlay">
            <strong>Skeleton Tracking: ON</strong><br>
            <small>Pose detection active</small>
        </div>
        <div class="video-container" id="videoContainer">
            <video id="webcamVideo" autoplay playsinline muted></video>
            <canvas id="poseCanvas"></canvas>
        </div>
        <div class="video-placeholder" id="videoPlaceholder">
            <div class="icon">üìπ</div>
            <p>Click to Start Webcam</p>
            <button class="btn btn-primary" onclick="startWebcam()">üé• Enable Camera</button>
            <p style="font-size: 0.8rem; opacity: 0.7; margin-top: 10px;">Skeleton overlay will appear on your body</p>
        </div>
    </div>
    
    <!-- Feedback Panel -->
    <div class="feedback-panel">
        <!-- Rep Counter -->
        <div class="rep-counter">
            <div class="count" id="repCount">0 / 10</div>
            <div class="label" id="setLabel">Reps (Set 1 of 3)</div>
        </div>
        
        <!-- Form Status Badge -->
        <div class="form-status">
            <div id="formStatusBadge" class="badge analyzing">‚è≥ ANALYZING...</div>
            <div class="score">Score: <span id="frameScoreText">--</span> / 50</div>
        </div>
        
        <!-- Real-time Feedback from ML -->
        <div class="realtime-feedback">
            <h4>ü§ñ AI Form Feedback</h4>
            <div id="feedbackList">
                <div class="feedback-item info">
                    üì∑ Position yourself in frame to begin analysis
                </div>
            </div>
        </div>

        <!-- Audio Indicator -->
        <div class="audio-indicator">
            <div class="audio-icon">üîä</div>
            <div>
                <strong>Voice Feedback: <span id="audioStatus">OFF</span></strong><br>
                <small>Click to toggle audio cues</small>
            </div>
            <button class="btn" onclick="toggleAudio()" style="margin-left: auto; padding: 5px 10px;">
                Toggle
            </button>
        </div>
        
        <!-- Exercise Info -->
        <div class="card" style="padding: 15px;">
            <h4>Current Exercise</h4>
            {% if workouts %}
            <div id="exerciseProgress" style="margin-top: 8px; font-size: 0.85rem; color: #666;">
                Exercise <span id="exerciseIndex">1</span> of {{ workouts|length }}
            </div>
            <div id="exerciseNameDisplay" style="font-size: 1.1rem; font-weight: bold; margin-top: 6px; color: #333;">
                {{ workouts[0].exercise_name }}
            </div>
            <!-- Hidden select to keep workout IDs available to JS -->
            <select id="workoutSelect" style="display: none;">
                {% for w in workouts %}
                <option value="{{ w.id }}" data-name="{{ w.exercise_name }}" data-sets="{{ w.sets }}" data-reps="{{ w.reps }}">
                    {{ w.exercise_name }}
                </option>
                {% endfor %}
            </select>
            <!-- Exercise step indicators -->
            <div id="exerciseSteps" style="display: flex; gap: 6px; margin-top: 10px; flex-wrap: wrap;">
                {% for w in workouts %}
                <span class="exercise-step {% if loop.first %}active{% endif %}" id="step-{{ loop.index0 }}"
                      style="padding: 4px 10px; border-radius: 12px; font-size: 0.8rem;
                             {% if loop.first %}background: #007bff; color: white;{% else %}background: #e9ecef; color: #666;{% endif %}">
                    {{ loop.index }}. {{ w.exercise_name }}
                </span>
                {% endfor %}
            </div>
            {% else %}
            <p style="color: #c00; margin-top: 5px;">‚ö†Ô∏è No exercises assigned yet. Ask your clinician to create a plan.</p>
            {% endif %}
            <p style="font-size: 0.85rem; margin-top: 10px;" id="exerciseTarget">
                {% if workouts %}
                Target: {{ workouts[0].sets }} sets √ó {{ workouts[0].reps }} reps
                {% else %}
                No target set
                {% endif %}
            </p>
        </div>
        
        <!-- Session Controls -->
        <div class="session-controls">
            <button class="btn" style="flex: 1;" onclick="togglePause()" id="pauseBtn">‚è∏Ô∏è Pause</button>
            <button class="btn btn-danger" style="flex: 1;" onclick="stopSession()">‚èπÔ∏è Stop Session</button>
        </div>
        
        {% if workouts and workouts|length > 1 %}
        <!-- Next Exercise Button -->
        <button id="nextExerciseBtn" class="btn btn-success" style="text-align: center; width: 100%;" onclick="nextExercise()">
            Next Exercise ‚û°Ô∏è
        </button>
        {% endif %}
    </div>
</div>

<script>
    // State variables
    let webcamStream = null;
    let isAnalyzing = false;
    let isPaused = false;
    let audioEnabled = false;
    let currentRep = 0;
    let currentSet = 1;
    let targetReps = {{ workouts[0].reps if workouts else 10 }};
    let targetSets = {{ workouts[0].sets if workouts else 3 }};
    let sessionStartTime = null;
    let allScores = [];  // Track all quality scores during session
    
    // Unique session group ID ‚Äî groups all exercises done in one sitting
    const sessionGroupId = 'SG-' + Date.now() + '-' + Math.random().toString(36).substr(2, 6);
    
    // Helper: calculate total reps completed across all finished sets + current partial set
    function getTotalRepsCompleted() {
        // If exercise finished (currentRep == targetReps && currentSet == targetSets), all reps done
        if (currentRep >= targetReps && currentSet >= targetSets) {
            return targetSets * targetReps;
        }
        // Otherwise: completed sets * reps + partial reps in current set
        return ((currentSet - 1) * targetReps) + currentRep;
    }
    
    // Get workout ID from the exercise selector dropdown
    function getWorkoutId() {
        const sel = document.getElementById('workoutSelect');
        return sel ? parseInt(sel.value) : null;
    }
    
    // Update display when user picks a different exercise
    function onWorkoutChange() {
        const sel = document.getElementById('workoutSelect');
        if (!sel) return;
        const opt = sel.options[sel.selectedIndex];
        const sets = opt.dataset.sets || 3;
        const reps = opt.dataset.reps || 10;
        targetSets = parseInt(sets);
        targetReps = parseInt(reps);
        currentRep = 0;
        currentSet = 1;
        allScores = [];
        isAnalyzing = true;
        updateRepCounter();
        document.getElementById('exerciseTarget').textContent =
            'Target: ' + sets + ' sets √ó ' + reps + ' reps';
        
        // Update exercise name display
        const nameDisplay = document.getElementById('exerciseNameDisplay');
        if (nameDisplay) nameDisplay.textContent = opt.dataset.name || opt.textContent.trim();
        
        // Update progress indicator
        const indexDisplay = document.getElementById('exerciseIndex');
        if (indexDisplay) indexDisplay.textContent = sel.selectedIndex + 1;
        
        // Update step indicators
        document.querySelectorAll('.exercise-step').forEach((step, i) => {
            if (i < sel.selectedIndex) {
                step.style.background = '#28a745'; step.style.color = 'white'; // completed
            } else if (i === sel.selectedIndex) {
                step.style.background = '#007bff'; step.style.color = 'white'; // current
            } else {
                step.style.background = '#e9ecef'; step.style.color = '#666'; // upcoming
            }
        });
        
        // Update Next Exercise button label
        updateNextExerciseBtn();
    }
    
    // Update Next Exercise button text based on current position
    function updateNextExerciseBtn() {
        const btn = document.getElementById('nextExerciseBtn');
        if (!btn) return;
        const sel = document.getElementById('workoutSelect');
        if (!sel) return;
        if (sel.selectedIndex >= sel.options.length - 1) {
            btn.textContent = '‚úÖ Finish Session';
            btn.classList.remove('btn-success');
            btn.classList.add('btn-primary');
        } else {
            btn.textContent = 'Next Exercise ‚û°Ô∏è';
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-success');
        }
    }
    
    // Advance to the next exercise (save current exercise data first)
    async function nextExercise() {
        const sel = document.getElementById('workoutSelect');
        if (!sel) return;
        
        isAnalyzing = false;
        
        // Save current exercise session silently
        const workoutId = getWorkoutId();
        if (workoutId) {
            const duration = Math.floor((Date.now() - (sessionStartTime || Date.now())) / 1000);
            const avgScore = allScores.length > 0
                ? Math.round(allScores.reduce((a, b) => a + b, 0) / allScores.length)
                : 0;
            
            try {
                await fetch('/api/session/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        workout_id: workoutId,
                        session_group_id: sessionGroupId,
                        duration_seconds: duration,
                        reps_completed: getTotalRepsCompleted(),
                        sets_completed: currentSet,
                        quality_score: avgScore,
                        pain_level_before: 0,
                        pain_level_after: 0,
                        perceived_effort: 5,
                        notes: 'Auto-saved on exercise advance'
                    })
                });
                addFeedback('success', 'üíæ Exercise progress saved!');
            } catch (err) {
                console.error('Error saving exercise:', err);
            }
        }
        
        // If this was the last exercise, show the completion modal
        if (sel.selectedIndex >= sel.options.length - 1) {
            stopSession();
            return;
        }
        
        // Move to next exercise
        sel.selectedIndex += 1;
        sessionStartTime = Date.now();
        onWorkoutChange();
        addFeedback('info', '‚û°Ô∏è Moving to next exercise: ' + sel.options[sel.selectedIndex].dataset.name);
    }
    
    // Start webcam
    async function startWebcam() {
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            try {
                webcamStream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 640, height: 480, facingMode: 'user' },
                    audio: false
                });
                
                const video = document.getElementById('webcamVideo');
                video.srcObject = webcamStream;
                
                document.getElementById('videoPlaceholder').style.display = 'none';
                document.getElementById('videoContainer').style.display = 'block';
                
                // Initialize session on backend
                sessionStartTime = Date.now();
                await fetch('/api/session/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        threshold: 30.0,
                        workout_id: getWorkoutId()
                    })
                });
                
                // Start pose analysis loop
                isAnalyzing = true;
                analyzePose();
                
                addFeedback('success', '‚úì Camera connected - Begin your exercise');
            } catch (err) {
                console.error('Error accessing webcam:', err);
                addFeedback('error', '‚úó Could not access camera. Please allow camera permissions.');
            }
        } else {
            alert('Camera access is not supported in this browser.');
            addFeedback('error', '‚úó Camera access is not supported in this browser.');
        }
    }
    
    // Simulated pose analysis (replace with actual ML model)
    function analyzePose() {
        if (!isAnalyzing || isPaused) {
            setTimeout(analyzePose, 500);
            return;
        }
        
        // This is where you'd integrate your ML model
        // For now, simulating random feedback
        const formScore = Math.floor(Math.random() * 30) + 20; // 20-50
        updateFormStatus(formScore);
        
        // Simulate rep counting
        if (Math.random() > 0.9) {
            incrementRep();
        }
        
        // Continue analysis loop
        setTimeout(analyzePose, 100); // Analyze every 100ms
    }
    
    // Update form status based on ML score
    function updateFormStatus(score) {
        const badge = document.getElementById('formStatusBadge');
        const scoreText = document.getElementById('frameScoreText');
        
        scoreText.textContent = score;
        allScores.push(score);  // Track score for averaging
        
        if (score >= 40) {
            badge.className = 'badge correct';
            badge.textContent = '‚úì CORRECT FORM';
        } else if (score >= 25) {
            badge.className = 'badge analyzing';
            badge.textContent = '‚ö†Ô∏è ADJUST FORM';
            // Add random feedback
            if (Math.random() > 0.95) {
                const feedbacks = [
                    'Keep your back straight',
                    'Slow down the movement',
                    'Extend fully at the top',
                    'Control the descent',
                    'Keep knees aligned with toes'
                ];
                addFeedback('warning', '‚ö†Ô∏è ' + feedbacks[Math.floor(Math.random() * feedbacks.length)]);
            }
        } else {
            badge.className = 'badge incorrect';
            badge.textContent = '‚úó FORM NEEDS WORK';
            if (audioEnabled) {
                speakFeedback('Adjust your form');
            }
        }
    }
    
    // Add feedback item to the list
    function addFeedback(type, message) {
        const feedbackList = document.getElementById('feedbackList');
        const item = document.createElement('div');
        item.className = `feedback-item ${type}`;
        item.textContent = message;
        
        // Add to top of list
        feedbackList.insertBefore(item, feedbackList.firstChild);
        
        // Keep only last 10 items
        while (feedbackList.children.length > 10) {
            feedbackList.removeChild(feedbackList.lastChild);
        }
        
        // Speak if audio enabled and it's a warning/error
        if (audioEnabled && (type === 'warning' || type === 'error')) {
            speakFeedback(message.replace(/^[‚ö†Ô∏è‚úó‚úìü§ñüì∑]+ /, ''));
        }
    }
    
    // Increment rep counter
    function incrementRep() {
        currentRep++;
        if (currentRep >= targetReps) {
            if (currentSet >= targetSets) {
                // All sets complete ‚Äî don't increment currentSet past targetSets
                currentRep = targetReps; // keep display at full reps for last set
                isAnalyzing = false;
                const sel = document.getElementById('workoutSelect');
                const hasMore = sel && sel.selectedIndex < sel.options.length - 1;
                if (hasMore) {
                    addFeedback('success', 'üéâ Exercise complete! Click "Next Exercise ‚û°Ô∏è" to continue.');
                    // Pulse the Next Exercise button to draw attention
                    const btn = document.getElementById('nextExerciseBtn');
                    if (btn) {
                        btn.style.animation = 'pulse 1s infinite';
                        setTimeout(() => { btn.style.animation = ''; }, 5000);
                    }
                } else {
                    addFeedback('success', 'üéâ All exercises complete! Great job!');
                }
            } else {
                addFeedback('success', `‚úì Set ${currentSet} complete! Starting set ${currentSet + 1}`);
                currentRep = 0;
                currentSet++;
            }
        }
        updateRepCounter();
    }
    
    // Update rep counter display
    function updateRepCounter() {
        document.getElementById('repCount').textContent = `${currentRep} / ${targetReps}`;
        document.getElementById('setLabel').textContent = `Reps (Set ${currentSet} of ${targetSets})`;
    }
    
    // Toggle audio feedback
    function toggleAudio() {
        audioEnabled = !audioEnabled;
        document.getElementById('audioStatus').textContent = audioEnabled ? 'ON' : 'OFF';
        addFeedback('info', audioEnabled ? 'üîä Voice feedback enabled' : 'üîá Voice feedback disabled');
    }
    
    // Text-to-speech feedback
    function speakFeedback(text) {
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 1.0;
            utterance.pitch = 1.0;
            window.speechSynthesis.speak(utterance);
        }
    }
    
    // Toggle pause
    function togglePause() {
        isPaused = !isPaused;
        const btn = document.getElementById('pauseBtn');
        btn.textContent = isPaused ? '‚ñ∂Ô∏è Resume' : '‚è∏Ô∏è Pause';
        addFeedback('info', isPaused ? '‚è∏Ô∏è Session paused' : '‚ñ∂Ô∏è Session resumed');
    }
    
    // Stop session
    async function stopSession() {
        if (!confirm('End this session and save your progress?')) {
            return;
        }
        
        if (!getWorkoutId()) {
            alert('No exercise assigned. Please ask your clinician to create a plan first.');
            window.location.href = "{{ url_for('patient_dashboard') }}";
            return;
        }
        
        isAnalyzing = false;
        if (webcamStream) {
            webcamStream.getTracks().forEach(track => track.stop());
        }
        
        // Show completion modal with pain/effort check-in
        showCompletionModal();
    }
    
    // Show completion modal for pain and effort check-in
    function showCompletionModal() {
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: flex; align-items: center;
            justify-content: center; z-index: 1000;
        `;
        
        modal.innerHTML = `
            <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%;">
                <h2 style="margin-top: 0;">Session Complete! üéâ</h2>
                <p style="color: #666;">You completed ${getTotalRepsCompleted()} total reps across ${currentSet} sets.</p>
                
                <form id="completionForm" style="margin-top: 20px;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Pain Before (0-10):</label>
                        <input type="range" id="painBefore" name="pain_before" min="0" max="10" value="0" 
                               style="width: 100%;" oninput="document.getElementById('painBeforeVal').textContent = this.value">
                        <span id="painBeforeVal">0</span>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Pain After (0-10):</label>
                        <input type="range" id="painAfter" name="pain_after" min="0" max="10" value="0" 
                               style="width: 100%;" oninput="document.getElementById('painAfterVal').textContent = this.value">
                        <span id="painAfterVal">0</span>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Effort Level (1-10):</label>
                        <input type="range" id="effortLevel" name="effort_level" min="1" max="10" value="5" 
                               style="width: 100%;" oninput="document.getElementById('effortVal').textContent = this.value">
                        <span id="effortVal">5</span>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Notes (optional):</label>
                        <textarea id="notes" name="notes" rows="3" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd;"></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="button" onclick="saveSessionData()" class="btn btn-primary" style="flex: 1;">
                            Save & Continue
                        </button>
                        <button type="button" onclick="location.href='{{ url_for('patient_dashboard') }}'" class="btn" style="flex: 1;">
                            Skip
                        </button>
                    </div>
                </form>
            </div>
        `;
        
        document.body.appendChild(modal);
        window.completionModal = modal;
    }
    
    // Save session data to database
    async function saveSessionData() {
        const painBefore = parseInt(document.getElementById('painBefore').value);
        const painAfter = parseInt(document.getElementById('painAfter').value);
        const effortLevel = parseInt(document.getElementById('effortLevel').value);
        const notes = document.getElementById('notes').value;
        
        // Calculate average quality score
        const avgQuality = allScores.length > 0 
            ? allScores.reduce((a, b) => a + b, 0) / allScores.length 
            : 0;
        
        // Prepare session data
        const sessionData = {
            workout_id: getWorkoutId(),
            session_group_id: sessionGroupId,
            pain_before: painBefore,
            pain_after: painAfter,
            effort_level: effortLevel,
            quality_score: avgQuality,
            sets_completed: currentSet,
            reps_completed: getTotalRepsCompleted(),
            notes: notes
        };
        
        try {
            const response = await fetch('/api/session/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(sessionData)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                alert('Session saved successfully! üéâ');
                window.location.href = "{{ url_for('patient_dashboard') }}";
            } else {
                alert('Error saving session: ' + (result.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error saving session:', error);
            alert('Error saving session. Please try again.');
        }
    }
    
    // Cleanup on page leave
    window.addEventListener('beforeunload', () => {
        if (webcamStream) {
            webcamStream.getTracks().forEach(track => track.stop());
        }
    });
</script>
{% endblock %}