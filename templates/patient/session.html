{% extends 'base.html' %}

{% block title %}Rehab Session - Home Rehab Coach{% endblock %}

{% block header %}
<header class="header">
    <h1><a href="{{ url_for('patient_dashboard') }}"><img src="{{ url_for('static', filename='rehab-logo.png') }}" alt="Home Rehab Coach logo" class="brand-logo"> Home Rehab Coach</a></h1>
    <nav class="nav-links">
        <a href="{{ url_for('patient_dashboard') }}">Dashboard</a>
        <a href="{{ url_for('patient_appointments') }}">Consultations</a>
        <div class="nav-user">
            <button class="nav-user-btn" title="Account"><i class="fa-solid fa-user"></i></button>
            <div class="nav-user-dropdown">
                <div class="nav-user-dropdown-inner">
                    <div class="dropdown-header">Signed in as<strong>{{ user.name if user else 'Patient' }}</strong></div>
                    <a href="{{ url_for('patient_profile') }}"><span class="dropdown-icon"><i class="fa-solid fa-user"></i></span> My Profile</a>
                    <div class="dropdown-divider"></div>
                    <a href="{{ url_for('logout') }}" class="dropdown-logout"><span class="dropdown-icon"><i class="fa-solid fa-right-from-bracket"></i></span> Logout</a>
                </div>
            </div>
        </div>
    </nav>
</header>
{% endblock %}

{% block content %}
<style>
    /* ===== Phase screens ===== */
    .phase-screen { display: none; }
    .phase-screen.active { display: block; }

    /* ===== Pre-session ===== */
    .pre-session-card {
        max-width: 620px; margin: 40px auto; background: #fff; border-radius: 14px;
        box-shadow: 0 4px 20px rgba(0,0,0,.08); padding: 36px;
    }
    .pre-session-card h2 { margin-top: 0; font-size: 1.5rem; }
    .exercise-list { list-style: none; padding: 0; margin: 18px 0; }
    .exercise-list li {
        padding: 12px 16px; border-radius: 8px; background: #f0f4ff;
        margin-bottom: 8px; font-weight: 500; display: flex; justify-content: space-between;
    }
    .exercise-list li .meta { color: #666; font-weight: 400; font-size: .9rem; }
    .pain-slider-group { margin: 22px 0; }
    .pain-slider-group label { font-weight: 600; display: block; margin-bottom: 6px; }
    .pain-slider-group input[type=range] { width: 100%; }
    .pain-value { font-size: 1.3rem; font-weight: 700; color: #007bff; }
    .btn-start-session {
        width: 100%; padding: 14px; font-size: 1.1rem; font-weight: 700;
        border: none; border-radius: 10px; background: linear-gradient(135deg,#007bff,#0056d2);
        color: #fff; cursor: pointer; margin-top: 12px; transition: .2s;
    }
    .btn-start-session:hover { transform: translateY(-1px); box-shadow: 0 4px 14px rgba(0,91,187,.35); }

    /* ===== Live session layout ===== */
    .live-session-grid {
        display: grid; grid-template-columns: 1fr 340px; gap: 18px;
        max-width: 1200px; margin: 20px auto; padding: 0 12px;
    }
    @media (max-width: 900px) { .live-session-grid { grid-template-columns: 1fr; } }

    /* Timers bar */
    .timers-bar { display: flex; gap: 14px; margin-bottom: 14px; }
    .timer-card {
        flex: 1; background: #fff; border-radius: 10px; padding: 14px 18px;
        box-shadow: 0 2px 10px rgba(0,0,0,.06); text-align: center;
    }
    .timer-card .timer-label { font-size: .8rem; color: #888; text-transform: uppercase; letter-spacing: .5px; }
    .timer-card .timer-value { font-size: 1.5rem; font-weight: 700; margin-top: 4px; font-family: 'Courier New', monospace; }

    /* Video panel */
    .video-panel-wrap { background: #1a1a2e; border-radius: 12px; overflow: hidden; position: relative; }
    .video-container { position: relative; width: 100%; }
    .video-container video { width: 100%; display: block; }
    .video-container canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    .video-placeholder {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        min-height: 380px; color: #aaa;
    }
    .video-placeholder .icon { font-size: 3rem; margin-bottom: 10px; }
    .skeleton-overlay {
        position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,.6);
        color: #0f0; padding: 6px 12px; border-radius: 6px; font-size: .75rem; z-index: 2;
    }

    /* Sidebar */
    .session-sidebar { display: flex; flex-direction: column; gap: 14px; }

    /* Cards */
    .s-card {
        background: #fff; border-radius: 10px; padding: 18px;
        box-shadow: 0 2px 10px rgba(0,0,0,.06);
    }
    .s-card h4 { margin: 0 0 10px; font-size: .95rem; color: #555; }

    /* Progress bar */
    .progress-bar-outer { background: #e9ecef; border-radius: 8px; height: 14px; overflow: hidden; }
    .progress-bar-inner {
        height: 100%; border-radius: 8px; background: linear-gradient(90deg,#28a745,#20c997);
        transition: width .4s ease; width: 0%;
    }
    .progress-perc { font-size: 1.1rem; font-weight: 700; margin-top: 6px; color: #28a745; }

    /* Exercise steps sidebar */
    .exercise-step-list { list-style: none; padding: 0; margin: 8px 0 0; }
    .exercise-step-list li {
        padding: 8px 12px; border-radius: 8px; margin-bottom: 6px; font-size: .88rem;
        display: flex; align-items: center; gap: 8px; transition: .2s;
    }
    .exercise-step-list li.completed { background: #d4edda; color: #155724; }
    .exercise-step-list li.current   { background: #cce5ff; color: #004085; font-weight: 600; }
    .exercise-step-list li.upcoming  { background: #f8f9fa; color: #888; }
    .exercise-step-list li .step-icon { font-size: 1rem; }

    /* Rep counter */
    .rep-counter-card { text-align: center; }
    .rep-counter-card .count { font-size: 2rem; font-weight: 800; color: #333; }
    .rep-counter-card .label { font-size: .85rem; color: #888; margin-top: 4px; }
    .rep-counter-card.rep-pulse .count {
        animation: repPulse 0.6s ease-out;
    }

    @keyframes repPulse {
        0% { transform: scale(1); color: #28a745; }
        50% { transform: scale(1.15); color: #20c997; }
        100% { transform: scale(1); color: #333; }
    }

    /* Form status */
    .form-status {
        text-align: center; padding: 14px; background: #fff; border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,.06);
    }
    .form-status .badge {
        display: inline-block; padding: 8px 18px; border-radius: 20px;
        font-weight: bold; font-size: .95rem; margin-bottom: 6px;
    }
    .form-status .badge.correct   { background: #d4edda; color: #155724; border: 2px solid #28a745; }
    .form-status .badge.incorrect { background: #f8d7da; color: #721c24; border: 2px solid #dc3545; animation: pulse-warning 1s infinite; }
    .form-status .badge.analyzing { background: #fff3cd; color: #856404; border: 2px solid #ffc107; }
    @keyframes pulse-warning { 0%,100%{transform:scale(1)} 50%{transform:scale(1.05)} }
    .form-status .score { font-size: 1rem; color: #333; font-weight: 600; }

    /* Feedback list */
    .realtime-feedback {
        background: #fff; border-radius: 10px; padding: 14px;
        max-height: 180px; overflow-y: auto; box-shadow: 0 2px 10px rgba(0,0,0,.06);
    }
    .realtime-feedback h4 { margin: 0 0 8px; font-size: .9rem; color: #555; }
    .feedback-item {
        padding: 6px 10px; margin-bottom: 6px; border-radius: 6px; font-size: .82rem;
        animation: slideIn .3s ease;
    }
    @keyframes slideIn { from{opacity:0;transform:translateX(-10px)} to{opacity:1;transform:translateX(0)} }
    .feedback-item.warning { background:#fff3cd; border-left:3px solid #ffc107; color:#856404; }
    .feedback-item.error   { background:#f8d7da; border-left:3px solid #dc3545; color:#721c24; }
    .feedback-item.success { background:#d4edda; border-left:3px solid #28a745; color:#155724; }
    .feedback-item.info    { background:#d1ecf1; border-left:3px solid #17a2b8; color:#0c5460; }

    /* Exercise selector */
    .exercise-checkbox {
        accent-color: #007bff;
    }
    #exerciseSelector label {
        background: #f9f9f9;
        color: #333;
        font-weight: 500;
    }
    #exerciseSelector label:hover {
        background: #f0f4ff;
        border-color: #007bff !important;
    }
    #exerciseSelector input:checked + * {
        background: #e7f3ff;
    }
    #exerciseSelector label:has(input:checked) {
        background: #e7f3ff;
        border-color: #007bff !important;
        color: #0056d2;
    }

    /* Controls */
    .session-controls { display: flex; gap: 10px; }
    .session-controls .btn { flex: 1; padding: 10px; font-size: .95rem; border-radius: 8px; cursor: pointer; border: none; }
    .btn-pause { background: #ffc107; color: #333; font-weight: 600; }
    .btn-stop  { background: #dc3545; color: #fff; font-weight: 600; }
    .btn-next  {
        background: #28a745; color: #fff; font-weight: 700; width: 100%; padding: 12px;
        border: none; border-radius: 10px; font-size: 1rem; cursor: pointer;
    }
    .btn-next:hover { background: #218838; }

    /* Audio indicator */
    .audio-indicator {
        display: flex; align-items: center; gap: 10px; background: #fff;
        border-radius: 10px; padding: 12px 16px; box-shadow: 0 2px 10px rgba(0,0,0,.06); font-size: .85rem;
    }

    /* Sidebar mini-cards */
    .sidebar-mini-card {
        background: #fff; border-radius: 10px; padding: 14px 16px;
        box-shadow: 0 2px 10px rgba(0,0,0,.06);
    }
    .sidebar-mini-card h4 { margin: 0 0 8px; font-size: .9rem; color: #555; }
    .sidebar-mini-card select {
        width: 100%; padding: 6px 10px; border-radius: 6px; border: 1px solid #ddd; font-size: .9rem;
    }
    .sidebar-mini-card label { font-size: .85rem; cursor: pointer; }

    /* ===== Post-session overlay ===== */
    .post-overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,.7);
        display: flex; align-items: center; justify-content: center; z-index: 1000;
    }
    .post-card {
        background: #fff; padding: 34px; border-radius: 14px; max-width: 500px; width: 92%;
        box-shadow: 0 8px 40px rgba(0,0,0,.25);
    }
    .post-card h2 { margin-top: 0; }

    @keyframes pulse {
        0%{transform:scale(1);box-shadow:0 0 0 0 rgba(40,167,69,.7)}
        50%{transform:scale(1.05);box-shadow:0 0 0 10px rgba(40,167,69,0)}
        100%{transform:scale(1);box-shadow:0 0 0 0 rgba(40,167,69,0)}
    }
</style>

<!-- ===================== PHASE 1 ‚Äî PRE-SESSION ===================== -->
<div id="phasePreSession" class="phase-screen active">
    <div class="pre-session-card">
        <h2><i class="fa-solid fa-dumbbell"></i> Select Your Exercises</h2>
        <p style="color:#666;">Choose which exercises you'd like to do today (in any order). All will have 3 sets x 10 reps.</p>

        <!-- Available exercises -->
        <div style="margin: 18px 0;">
            <label style="font-weight:600; display:block; margin-bottom:12px;">Available Exercises:</label>
            <div id="exerciseSelector" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(160px, 1fr)); gap:10px; margin-bottom:20px;">
                <label style="display:flex; align-items:center; padding:12px; border:2px solid #ddd; border-radius:8px; cursor:pointer; transition:all 0.3s;">
                    <input type="checkbox" value="lifting_of_arms" class="exercise-checkbox" style="margin-right:8px; cursor:pointer;"> Lifting of Arms
                </label>
                <label style="display:flex; align-items:center; padding:12px; border:2px solid #ddd; border-radius:8px; cursor:pointer; transition:all 0.3s;">
                    <input type="checkbox" value="lateral_trunk_tilt" class="exercise-checkbox" style="margin-right:8px; cursor:pointer;"> Lateral Trunk Tilt
                </label>
                <label style="display:flex; align-items:center; padding:12px; border:2px solid #ddd; border-radius:8px; cursor:pointer; transition:all 0.3s;">
                    <input type="checkbox" value="trunk_rotation" class="exercise-checkbox" style="margin-right:8px; cursor:pointer;"> Trunk Rotation
                </label>
                <label style="display:flex; align-items:center; padding:12px; border:2px solid #ddd; border-radius:8px; cursor:pointer; transition:all 0.3s;">
                    <input type="checkbox" value="pelvis_rotation" class="exercise-checkbox" style="margin-right:8px; cursor:pointer;"> Pelvis Rotation
                </label>
                <label style="display:flex; align-items:center; padding:12px; border:2px solid #ddd; border-radius:8px; cursor:pointer; transition:all 0.3s;">
                    <input type="checkbox" value="squat" class="exercise-checkbox" style="margin-right:8px; cursor:pointer;"> Squat
                </label>
            </div>
        </div>

        <!-- Selected exercises list -->
        <div style="margin: 18px 0;">
            <label style="font-weight:600; display:block; margin-bottom:12px;">Your Selected Exercises:</label>
            <ul id="selectedExercisesList" style="list-style:none; padding:0; margin:0; background:#f9f9f9; padding:12px; border-radius:8px; min-height:40px;">
                <li style="color:#999; font-size:0.9rem;">No exercises selected yet</li>
            </ul>
        </div>

        <!-- Language selector -->
        <div style="margin: 18px 0;">
            <label style="font-weight:600; display:block; margin-bottom:6px;">Feedback Language</label>
            <select id="languageSelect" style="width:100%; padding:8px 12px; border-radius:8px; border:1px solid #ddd; font-size:.95rem;">
                <option value="English" selected>English</option>
                <option value="Tamil">Tamil</option>
                <option value="Chinese">Chinese</option>
                <option value="Malay">Malay</option>
                <option value="Thai">Thai</option>
            </select>
        </div>

        <div class="pain-slider-group">
            <label>How much pain do you feel right now? <span class="pain-value" id="painBeforeVal">0</span> / 10</label>
            <input type="range" id="painBeforeInput" min="0" max="10" value="0"
                   oninput="document.getElementById('painBeforeVal').textContent=this.value">
        </div>

        <button class="btn-start-session" onclick="startSession()"><i class="fa-solid fa-play"></i> Start Session</button>
    </div>
</div>

<!-- ===================== PHASE 2 ‚Äî LIVE SESSION ===================== -->
<div id="phaseLiveSession" class="phase-screen">

    <!-- Timers bar -->
    <div class="timers-bar" style="max-width:1200px;margin:14px auto 0;padding:0 12px;">
        <div class="timer-card">
            <div class="timer-label">Session Time</div>
            <div class="timer-value" id="sessionTimer">00:00</div>
        </div>
        <div class="timer-card">
            <div class="timer-label">Exercise Time</div>
            <div class="timer-value" id="exerciseTimer">00:00</div>
        </div>
    </div>

    <div class="live-session-grid">
        <!-- Left column: video + status + feedback -->
        <div>
            <div class="video-panel-wrap">
                <div class="skeleton-overlay">
                    <strong>Skeleton Tracking: ON</strong><br>
                    <small>Pose detection active</small>
                </div>
                <div class="video-container" id="videoContainer" style="display:none;">
                    <video id="webcamVideo" autoplay playsinline muted></video>
                    <canvas id="poseCanvas"></canvas>
                </div>
                <div class="video-placeholder" id="videoPlaceholder">
                    <div class="icon"><i class="fa-solid fa-video"></i></div>
                    <p>Camera will start when session begins</p>
                </div>
            </div>

            <!-- Form status + score -->
            <div class="form-status" style="margin-top:14px;">
                <div id="formStatusBadge" class="badge analyzing"><i class="fa-solid fa-hourglass-half"></i> ANALYZING...</div>
                <div class="score">Score: <span id="frameScoreText">--</span> / 50</div>
            </div>

            <!-- Realtime feedback -->
            <div class="realtime-feedback" style="margin-top:14px;">
                <h4><i class="fa-solid fa-robot"></i> AI Form Feedback</h4>
                <div id="feedbackList">
                    <div class="feedback-item info"><i class="fa-solid fa-camera"></i> Position yourself in frame to begin analysis</div>
                </div>
            </div>

            <!-- Audio toggle -->
            <div class="audio-indicator" style="margin-top:14px;">
                <div><i class="fa-solid fa-volume-high"></i></div>
                <div><strong>Voice Feedback: <span id="audioStatus">OFF</span></strong><br><small>Click to toggle</small></div>
                <button id="audioToggleBtn" style="margin-left:auto;padding:5px 10px;border:1px solid #ccc;border-radius:6px;cursor:pointer;background:#fff;">Toggle</button>
            </div>
        </div>

        <!-- Right column: sidebar -->
        <div class="session-sidebar">
            <!-- Rep counter -->
            <div class="s-card rep-counter-card">
                <div class="count" id="repCount">0 / 10</div>
                <div class="label" id="setLabel">Reps (Set 1 of 3)</div>
            </div>

            <!-- Session completion progress -->
            <div class="s-card">
                <h4>Session Completion</h4>
                <div class="progress-bar-outer">
                    <div class="progress-bar-inner" id="sessionProgressBar"></div>
                </div>
                <div class="progress-perc" id="sessionProgressText">0%</div>
            </div>

            <!-- Exercise steps -->
            <div class="s-card">
                <h4>Exercises</h4>
                <ul class="exercise-step-list" id="exerciseStepList">
                    {% for w in workouts %}
                    <li id="exStep-{{ loop.index0 }}" class="{% if loop.first %}current{% else %}upcoming{% endif %}">
                        <span class="step-icon">
                            {% if loop.first %}
                                <i class="fa-solid fa-circle-dot"></i>
                            {% else %}
                                <i class="fa-regular fa-circle"></i>
                            {% endif %}
                        </span>
                        <span>{{ w.exercise_name }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>

            <!-- CV Detected Exercise -->
            <div class="sidebar-mini-card">
                <h4><i class="fa-solid fa-eye"></i> CV Detected Exercise</h4>
                <p style="font-size:.95rem; margin:4px 0 0;"><strong id="detectedExerciseText">--</strong></p>
                <p style="font-size:.8rem; color:#888; margin-top:4px;" id="exerciseMetaText">Target: --<br>ROM Target: --</p>
            </div>

            <!-- Exercise Mode -->
            <div class="sidebar-mini-card">
                <h4>Exercise Mode</h4>
                <div style="margin-bottom:8px;">
                    <label><input type="radio" name="exerciseMode" value="auto" checked> Auto Detect</label>
                    &nbsp;&nbsp;
                    <label><input type="radio" name="exerciseMode" value="manual"> Manual Select</label>
                </div>
                <select id="manualExerciseSelect" disabled>
                    <option value="squat">Squat</option>
                    <option value="lifting_of_arms">Lifting of Arms</option>
                    <option value="lateral_trunk_tilt">Lateral Trunk Tilt</option>
                    <option value="trunk_rotation">Trunk Rotation</option>
                    <option value="pelvis_rotation">Pelvis Rotation</option>
                </select>
            </div>

            <!-- Controls -->
            <div class="session-controls">
                <button class="btn btn-pause" onclick="togglePause()" id="pauseBtn"><i class="fa-solid fa-pause"></i> Pause</button>
                <button class="btn btn-stop" onclick="stopSession()"><i class="fa-solid fa-stop"></i> Stop</button>
            </div>
            <button id="nextExerciseBtn" class="btn-next" onclick="nextExercise()"
                {% if not workouts or workouts|length <= 1 %}style="display:none;"{% endif %}>
                <span class="next-label">Next Exercise</span> <i class="fa-solid fa-arrow-right"></i>
            </button>
        </div>
    </div>
</div>

<!-- Hidden workout data for JS -->
<script>
    const BACKEND_WORKOUTS = [
        {% for w in workouts %}
        { id: {{ w.id }}, name: "{{ w.exercise_name }}", sets: {{ w.sets }}, reps: {{ w.reps }} }{{ "," if not loop.last }}
        {% endfor %}
    ];
    // Will be replaced by user selections in startSession()
    let WORKOUTS = [];
</script>

<script>
/* ===================== EXERCISE SELECTION ===================== */
const AVAILABLE_EXERCISES = {
    "lifting_of_arms": { name: "Lifting of Arms", sets: 3, reps: 10 },
    "lateral_trunk_tilt": { name: "Lateral Trunk Tilt", sets: 3, reps: 10 },
    "trunk_rotation": { name: "Trunk Rotation", sets: 3, reps: 10 },
    "pelvis_rotation": { name: "Pelvis Rotation", sets: 3, reps: 10 },
    "squat": { name: "Squat", sets: 3, reps: 10 }
};

let selectedExerciseIds = [];

// Handle exercise checkbox changes
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.exercise-checkbox');
    checkboxes.forEach(cb => {
        cb.addEventListener('change', updateSelectedExercises);
    });
    updateSelectedExercises();
});

function updateSelectedExercises() {
    const checkboxes = document.querySelectorAll('.exercise-checkbox:checked');
    selectedExerciseIds = Array.from(checkboxes).map(cb => cb.value);
    
    const list = document.getElementById('selectedExercisesList');
    if (selectedExerciseIds.length === 0) {
        list.innerHTML = '<li style="color:#999; font-size:0.9rem;">No exercises selected yet</li>';
    } else {
        list.innerHTML = selectedExerciseIds.map((id, idx) => 
            `<li style="padding:6px 0; border-bottom:1px solid #eee;"><strong>${idx+1}. ${AVAILABLE_EXERCISES[id].name}</strong> - 3 sets √ó 10 reps</li>`
        ).join('');
    }
}

/* ===================== CONFIG ===================== */
const API_BASE = window.location.origin;
const THRESHOLD = 30.0;
const COOLDOWN_SECONDS = 2;
const POLL_MS = 100; // 200

const LANG_TO_BCP47 = {
    English: "en-US", Tamil: "ta-IN", Chinese: "zh-CN", Malay: "ms-MY", Thai: "th-TH"
};

/* ===================== STATE ===================== */
let sessionId = null;
let webcamStream = null;
let isPaused = false;
let audioEnabled = false;
let pollTimer = null;
let inflight = false;

let currentExIndex = 0;
let currentRep = 0;
let currentSet = 1;
let targetReps = 10;  // Default, will be set when user selects exercises
let targetSets = 3;   // Default, will be set when user selects exercises
let currentExerciseCompleted = false; // Track if current exercise already completed

let allScores = [];
let exerciseData = [];
let setsCompletedDict = {};

let sessionStartTs = null;
let exerciseStartTs = null;
let sessionTimerInterval = null;
let exerciseTimerInterval = null;

// TTS
let ttsAudio = null;
let isSpeaking = false;
let ttsQueue = [];
let lastSpokenHash = "";
let lastSpokenAt = 0;
const SPEAK_COOLDOWN_MS = 8000;

// CV feedback persistence
let LAST_FEEDBACK = null;
let LAST_FEEDBACK_TIME = 0;
let LAST_FEEDBACK_RENDER_TIME = 0;
const FEEDBACK_RENDER_COOLDOWN_MS = 2000; // Pause 2 seconds between feedback updates

// Exercise mode
let exerciseMode = "auto";
let manualExercise = "squat";

// Canvas for frame capture
const captureCanvas = document.createElement("canvas");
const captureCtx = captureCanvas.getContext("2d");

/* ===================== EXERCISE PLAN (CV metadata) ===================== */
const EXERCISE_PLAN = {
    "lifting_of_arms":    { reps: 10, sets: 3, target: "3 sets √ó 10 reps", rom: "Raise arms to shoulder height" },
    "lateral_trunk_tilt": { reps: 10, sets: 3, target: "3 sets √ó 10 reps", rom: "Tilt ~20‚Äì30¬∞ each side" },
    "trunk_rotation":     { reps: 10, sets: 3, target: "3 sets √ó 10 reps", rom: "Rotate comfortably (no pain)" },
    "pelvis_rotation":    { reps: 10, sets: 3, target: "3 sets √ó 10 reps", rom: "Small controlled pelvis rotation" },
    "squat":              { reps: 10, sets: 3, target: "3 sets √ó 10 reps", rom: "Hip crease to knee level (as tolerated)" },
    "idle":               { reps: 0,  sets: 0, target: "You are Idle", rom: "--" },
};

function normalizeExerciseName(name) {
    if (!name) return "idle";
    const n = name.toLowerCase().trim();
    if (n.includes("squat")) return "squat";
    if (n.includes("lifting")) return "lifting_of_arms";
    if (n.includes("lateral")) return "lateral_trunk_tilt";
    if (n.includes("trunk")) return "trunk_rotation";
    if (n.includes("pelvis")) return "pelvis_rotation";
    if (EXERCISE_PLAN[n]) return n;
    return "idle";
}

function updateExerciseUI(exerciseNameRaw) {
    const key = normalizeExerciseName(exerciseNameRaw);
    const plan = EXERCISE_PLAN[key] || EXERCISE_PLAN["idle"];
    const el = document.getElementById('detectedExerciseText');
    const meta = document.getElementById('exerciseMetaText');
    if (el) el.textContent = key.replaceAll("_", " ");
    if (meta) meta.innerHTML = "Target: " + plan.target + "<br>ROM Target: " + plan.rom;
}

/* ===================== EXERCISE MODE HANDLERS ===================== */
const modeRadios = document.querySelectorAll("input[name='exerciseMode']");
const manualSelect = document.getElementById("manualExerciseSelect");

modeRadios.forEach(function(r) {
    r.addEventListener("change", function() {
        exerciseMode = r.value;
        manualSelect.disabled = (exerciseMode !== "manual");
    });
});
if (manualSelect) {
    manualSelect.addEventListener("change", function() { manualExercise = manualSelect.value; });
}

/* ===================== HELPERS ===================== */
function fmt(seconds) {
    const m = String(Math.floor(seconds / 60)).padStart(2, '0');
    const s = String(seconds % 60).padStart(2, '0');
    return m + ':' + s;
}

function getWorkoutId() {
    return WORKOUTS.length ? WORKOUTS[currentExIndex].id : null;
}

function getLanguageName() {
    const sel = document.getElementById('languageSelect');
    return sel ? sel.value : "English";
}

function getTotalRepsCompleted() {
    let total;
    if (currentRep >= targetReps && currentSet >= targetSets) {
        total = targetSets * targetReps;
    } else {
        total = ((currentSet - 1) * targetReps) + currentRep;
    }
    console.log(`  getTotalRepsCompleted: rep=${currentRep}/${targetReps}, set=${currentSet}/${targetSets} ‚Üí ${total} reps`);
    return total;
}

function calcSessionProgress() {
    let totalReq = 0, totalDone = 0;
    WORKOUTS.forEach(function(w, i) {
        const exReq = w.sets * w.reps;
        totalReq += exReq;
        
        // Always check exerciseData first (for any completed or in-progress exercise)
        const saved = exerciseData[i];
        if (saved) {
            // Use saved data if available
            totalDone += Object.values(saved.sets_completed).reduce(function(a, b) { return a + b; }, 0);
        } else if (i === currentExIndex) {
            // Current exercise not yet saved, use live counters
            totalDone += getTotalRepsCompleted();
        }
        // If i < currentExIndex and not saved, it contributes 0 (shouldn't happen)
    });
    return totalReq > 0 ? Math.round(totalDone / totalReq * 100) : 0;
}

function updateSessionProgress() {
    const perc = calcSessionProgress();
    document.getElementById('sessionProgressBar').style.width = perc + '%';
    document.getElementById('sessionProgressText').textContent = perc + '%';
}

function updateRepCounter() {
    const repElement = document.getElementById('repCount');
    const setElement = document.getElementById('setLabel');
    const cardElement = document.querySelector('.rep-counter-card');
    
    const newRepText = currentRep + ' / ' + targetReps;
    const newSetText = 'Reps (Set ' + currentSet + ' of ' + targetSets + ')';
    
    console.log('üîÑ updateRepCounter called');
    console.log('  Elements:', { repElement, setElement, cardElement });
    console.log('  New Text:', { newRepText, newSetText });
    
    if (repElement) {
        console.log('  Updating repElement:', newRepText);
        repElement.textContent = newRepText;
    } else {
        console.log('  ‚ö†Ô∏è repElement not found!');
    }
    
    if (setElement) {
        console.log('  Updating setElement:', newSetText);
        setElement.textContent = newSetText;
    } else {
        console.log('  ‚ö†Ô∏è setElement not found!');
    }
    
    // Add pulse animation
    if (cardElement) {
        console.log('  Adding pulse animation');
        cardElement.classList.add('rep-pulse');
        setTimeout(function() {
            cardElement.classList.remove('rep-pulse');
        }, 600);
    } else {
        console.log('  ‚ö†Ô∏è cardElement not found!');
    }
    
    console.log('‚úÖ Rep counter updated:', newRepText, '|', newSetText);
}

function updateExerciseSteps() {
    WORKOUTS.forEach(function(w, i) {
        const li = document.getElementById('exStep-' + i);
        if (!li) return;
        const icon = li.querySelector('.step-icon i');
        if (i < currentExIndex) {
            li.className = 'completed';
            icon.className = 'fa-solid fa-circle-check';
        } else if (i === currentExIndex) {
            li.className = 'current';
            icon.className = 'fa-solid fa-circle-dot';
        } else {
            li.className = 'upcoming';
            icon.className = 'fa-regular fa-circle';
        }
    });
}

/* ===================== FEEDBACK UI ===================== */
function addFeedback(type, message) {
    const list = document.getElementById('feedbackList');
    const item = document.createElement('div');
    item.className = 'feedback-item ' + type;
    item.textContent = message;
    list.insertBefore(item, list.firstChild);
    while (list.children.length > 10) list.removeChild(list.lastChild);
}

function renderCVFeedback(items) {
    if (items && items.length > 0) {
        LAST_FEEDBACK = items;
        LAST_FEEDBACK_TIME = Date.now();
    }
    const displayItems = (LAST_FEEDBACK && LAST_FEEDBACK.length > 0) ? LAST_FEEDBACK : null;
    const list = document.getElementById('feedbackList');
    
    // Only update the feedback display if enough time has passed
    const now = Date.now();
    if (now - LAST_FEEDBACK_RENDER_TIME < FEEDBACK_RENDER_COOLDOWN_MS) {
        return;
    }
    
    list.innerHTML = '';
    if (!displayItems) {
        const div = document.createElement('div');
        div.className = 'feedback-item info';
        div.textContent = 'Position yourself in frame to begin analysis';
        list.appendChild(div);
        return;
    }
    displayItems.slice(0, 5).forEach(function(txt) {
        const div = document.createElement('div');
        div.className = 'feedback-item warning';
        div.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> ' + txt;
        list.appendChild(div);
    });
    LAST_FEEDBACK_RENDER_TIME = now;
}

function updateFormStatus(status, score) {
    const badge = document.getElementById('formStatusBadge');
    const scoreText = document.getElementById('frameScoreText');
    scoreText.textContent = Number(score || 0).toFixed(1);
    allScores.push(Number(score || 0));

    if (status === 'CORRECT') {
        badge.className = 'badge correct';
        badge.innerHTML = '<i class="fa-solid fa-circle-check"></i> CORRECT FORM';
    } else if (status === 'WRONG') {
        badge.className = 'badge incorrect';
        badge.innerHTML = '<i class="fa-solid fa-circle-xmark"></i> FORM NEEDS WORK';
    } else if (status === 'NO_POSE') {
        badge.className = 'badge analyzing';
        badge.innerHTML = '<i class="fa-solid fa-person"></i> POSE NOT DETECTED';
    } else if (status === 'ERROR') {
        badge.className = 'badge incorrect';
        badge.innerHTML = '<i class="fa-solid fa-circle-xmark"></i> ERROR';
    } else {
        badge.className = 'badge analyzing';
        badge.innerHTML = '<i class="fa-solid fa-hourglass-half"></i> ANALYZING...';
    }
}

/* ===================== REP COUNTING FROM BACKEND ===================== */
function updateRepUIFromBackend(out) {
    const oldRep = currentRep;
    const oldSet = currentSet;
    
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('updateRepUIFromBackend called');
    console.log('  Input:', { out, oldRep, oldSet });
    console.log('  Current State:', { currentRep, currentSet, targetReps, targetSets });
    
    let repIncremented = false;
    let setCompleted = false;
    let exerciseCompleted = false;
    
    if (out && out.rep_info && typeof out.rep_info === "object") {
        const r = out.rep_info;
        console.log('  ‚úÖ Got rep_info:', r);
        
        if (r.rep_now != null) {
            console.log(`  Rep: ${currentRep} ‚Üí ${r.rep_now}`);
            currentRep = r.rep_now;
        }
        if (r.rep_target != null) {
            console.log(`  Rep Target: ${targetReps} ‚Üí ${r.rep_target}`);
            targetReps = r.rep_target;
        }
        if (r.set_now != null) {
            console.log(`  Set: ${currentSet} ‚Üí ${r.set_now}`);
            currentSet = r.set_now;
        }
        if (r.set_target != null) {
            console.log(`  Set Target: ${targetSets} ‚Üí ${r.set_target}`);
            targetSets = r.set_target;
        }
        
        // Check for completion flags
        if (r.rep_incremented) {
            repIncremented = true;
            console.log('  üî•üî•üî• REP INCREMENTED! üî•üî•üî•');
            addFeedback('success', '‚úÖ Rep ' + currentRep + ' completed!');
        }
        
        if (r.set_completed) {
            setCompleted = true;
            console.log('  üéØüéØüéØ SET COMPLETED! üéØüéØüéØ');
        }
        
        if (r.exercise_completed) {
            exerciseCompleted = true;
            console.log('  üèÜüèÜüèÜ EXERCISE COMPLETED! üèÜüèÜüèÜ');
        }
    } else {
        console.log('  ‚ö†Ô∏è No rep_info in response, using fallback fields');
        if (out && out.rep_count != null) currentRep = out.rep_count;
        if (out && out.rep_target != null) targetReps = out.rep_target;
        if (out && out.set_index != null) currentSet = out.set_index;
        if (out && out.sets_total != null) targetSets = out.sets_total;
    }
    
    console.log('  After Update:', { currentRep, currentSet, targetReps, targetSets });
    console.log('  Flags:', { repIncremented, setCompleted, exerciseCompleted });
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    
    // IMPORTANT: When a rep completes a set, BOTH repIncremented and setCompleted are true
    // In that case, currentRep has been reset to 0, so we must NOT update the dict with it
    
    if (setCompleted) {
        // Set just completed: save the PREVIOUS set with all its reps (targetReps)
        // currentSet was already incremented, so the finished set is currentSet - 1
        setsCompletedDict[String(currentSet - 1)] = targetReps;
        console.log(`  üéØ SET COMPLETED: setsCompletedDict['${currentSet - 1}'] = ${targetReps}`);
    } else if (repIncremented) {
        // Mid-set: A new rep was counted, update the current set
        setsCompletedDict[String(currentSet)] = currentRep;
        console.log(`  ‚úÖ REP COUNTED: setsCompletedDict['${currentSet}'] = ${currentRep}`);
    }
    
    console.log(`     DICT STATE:`, Object.assign({}, setsCompletedDict));
    
    updateRepCounter();
    updateExerciseSteps();
    updateSessionProgress();
    
    // ‚úÖ SET COMPLETED - Show alert and speak
    if (setCompleted) {
        const setMsg = 'Set ' + (currentSet-1) + ' complete! Excellent work!';
        console.log('üéØ SET ALERT:', setMsg);
        addFeedback('success', 'üéØ ' + setMsg);
        queueSpeech(setMsg);
    }
    
    // ‚úÖ EXERCISE COMPLETED - Show alert and speak
    if (exerciseCompleted && !currentExerciseCompleted) {
        currentExerciseCompleted = true;  // Mark as completed to prevent duplicate triggers
        const exerciseMsg = 'Exercise completed! Fantastic effort! Go to the next exercise!';
        console.log('üèÜ EXERCISE ALERT:', exerciseMsg);
        addFeedback('success', 'üèÜ ' + exerciseMsg);
        queueSpeech(exerciseMsg);
        
        // Automatically move to next exercise after a brief delay
        setTimeout(function() {
            nextExercise();
        }, 3000);
    }
}

/* ===================== TTS (SERVER-SIDE /api/tts with browser fallback) ===================== */
function stopSpeaking() {
    try {
        if (ttsAudio) { ttsAudio.pause(); ttsAudio.src = ""; ttsAudio = null; }
    } catch (e) {}
    ttsQueue = [];
    isSpeaking = false;
    if ('speechSynthesis' in window) window.speechSynthesis.cancel();
}

async function playNextTTS() {
    if (ttsQueue.length === 0) { isSpeaking = false; return; }
    isSpeaking = true;
    const text = ttsQueue.shift();
    try {
        const res = await fetch(API_BASE + '/api/tts', {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text: text, language: getLanguageName() })
        });
        if (!res.ok) throw new Error("TTS HTTP " + res.status);
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        ttsAudio = new Audio(url);
        ttsAudio.playbackRate = 1.25;
        ttsAudio.onended = function() { URL.revokeObjectURL(url); playNextTTS(); };
        await ttsAudio.play();
    } catch (e) {
        console.error("Server TTS failed, using browser fallback:", e);
        if ('speechSynthesis' in window) {
            const u = new SpeechSynthesisUtterance(text);
            u.rate = 1.0; u.pitch = 1.0;
            u.onend = function() { playNextTTS(); };
            window.speechSynthesis.speak(u);
        } else {
            isSpeaking = false;
        }
    }
}

function queueSpeech(text) {
    if (!text || !audioEnabled) return;
    ttsQueue.push(text);
    if (!isSpeaking) playNextTTS();
}

async function speakFeedbackList(items) {
    if (!items || items.length === 0 || !audioEnabled) return;
    const now = Date.now();
    if (now - lastSpokenAt < SPEAK_COOLDOWN_MS) return;
    const hash = items.join("|");
    if (hash === lastSpokenHash) return;
    queueSpeech(items.slice(0, 2).join(". "));
    lastSpokenHash = hash;
    lastSpokenAt = now;
}

/* ===================== AUDIO TOGGLE ===================== */
document.getElementById('audioToggleBtn').addEventListener('click', function() {
    audioEnabled = !audioEnabled;
    document.getElementById('audioStatus').textContent = audioEnabled ? 'ON' : 'OFF';
    addFeedback('info', audioEnabled ? 'Voice feedback enabled' : 'Voice feedback disabled');
    if (!audioEnabled) stopSpeaking();
});

/* ===================== WEBCAM ===================== */
async function startWebcam() {
    try {
        webcamStream = await navigator.mediaDevices.getUserMedia({
            video: { width: 640, height: 480, facingMode: 'user' }, audio: false
        });
        const video = document.getElementById('webcamVideo');
        video.srcObject = webcamStream;
        document.getElementById('videoPlaceholder').style.display = 'none';
        document.getElementById('videoContainer').style.display = 'block';
        addFeedback('success', 'Camera connected ‚Äî Begin your exercise');
        return true;
    } catch (err) {
        console.error('Webcam error:', err);
        addFeedback('error', 'Could not access camera. Check permissions.');
        return false;
    }
}

function stopCamera() {
    if (webcamStream) {
        webcamStream.getTracks().forEach(function(t) { t.stop(); });
        webcamStream = null;
    }
}

function grabFrameDataURL() {
    const video = document.getElementById('webcamVideo');
    const w = video.videoWidth, h = video.videoHeight;
    if (!w || !h) return null;
    const targetW = 640;
    const targetH = Math.round((h / w) * targetW);
    captureCanvas.width = targetW;
    captureCanvas.height = targetH;
    captureCtx.drawImage(video, 0, 0, targetW, targetH);
    return captureCanvas.toDataURL("image/jpeg", 0.65);
}

/* ===================== CV POLLING ===================== */
async function pollFeedback() {
    if (inflight || isPaused) return;
    inflight = true;

    const frame_b64 = grabFrameDataURL();
    if (!frame_b64) { inflight = false; return; }

    try {
        const res = await fetch(API_BASE + '/api/live_feedback', {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                frame_b64: frame_b64,
                language: getLanguageName(),
                mode: exerciseMode,
                manual_exercise: manualExercise
            })
        });

        const out = await res.json().catch(function() { return {}; });

        console.log('Backend response:', out);
        updateRepUIFromBackend(out);
        if (out.exercise_name) updateExerciseUI(out.exercise_name);

        if (!res.ok) {
            updateFormStatus("ERROR", 0);
            renderCVFeedback([out.error || ("Backend error (HTTP " + res.status + ")")]);
            return;
        }

        updateFormStatus(out.form_status, out.frame_score);

        var fb = out.llm_feedback;
        if (typeof fb === "string") fb = [fb];
        renderCVFeedback(fb);

        if (out.form_status === "WRONG" && fb && fb.length > 0) {
            await speakFeedbackList(fb);
        }
    } catch (e) {
        console.error("pollFeedback error:", e);
        updateFormStatus("ERROR", 0);
        renderCVFeedback(["Network error reaching backend"]);
    } finally {
        inflight = false;
    }
}

function startPolling() {
    if (pollTimer) clearInterval(pollTimer);
    pollTimer = setInterval(function() { if (!isPaused) pollFeedback(); }, POLL_MS);
}

function stopPolling() {
    if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
}

/* ===================== BACKEND SESSION API ===================== */
async function callSessionStart() {
    try {
        const w = WORKOUTS[currentExIndex];
        const payload = {
            threshold: THRESHOLD,
            cooldown_seconds: COOLDOWN_SECONDS,
            language: getLanguageName(),
            target_reps: w ? w.reps : targetReps,
            target_sets: w ? w.sets : targetSets
        };
        console.log('üéØ Starting session with payload:', payload);
        
        const resp = await fetch(API_BASE + '/api/session/start', {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });
        const result = await resp.json();
        console.log('‚úÖ Session start response:', result);
    } catch (e) {
        console.error("‚ùå session/start failed:", e);
    }
}

/* ===================== PHASE 1 ‚Üí PHASE 2 ===================== */
async function startSession() {
    // Check if exercises are selected
    if (selectedExerciseIds.length === 0) {
        alert('Please select at least one exercise to continue.');
        return;
    }
    
    // Build WORKOUTS array from selected exercises
    const userSelectedWorkouts = selectedExerciseIds.map((id, idx) => ({
        id: idx + 1,
        name: AVAILABLE_EXERCISES[id].name,
        exercise_id: id,
        sets: AVAILABLE_EXERCISES[id].sets,
        reps: AVAILABLE_EXERCISES[id].reps
    }));
    
    // Replace WORKOUTS with user selections
    // Clear and repopulate the global WORKOUTS array
    WORKOUTS.length = 0;  // Clear existing
    WORKOUTS.push(...userSelectedWorkouts);  // Add user selections
    console.log('‚úÖ WORKOUTS set to user selections:', WORKOUTS);
    
    // Dynamically rebuild exercise steps list
    const exerciseStepList = document.getElementById('exerciseStepList');
    if (exerciseStepList) {
        exerciseStepList.innerHTML = userSelectedWorkouts.map((w, idx) => `
            <li id="exStep-${idx}" class="${idx === 0 ? 'current' : 'upcoming'}">
                <span class="step-icon">
                    <i class="fa-solid ${idx === 0 ? 'fa-circle-dot' : 'fa-regular fa-circle'}"></i>
                </span>
                <span>${w.name}</span>
            </li>
        `).join('');
    }
    
    const painBefore = parseInt(document.getElementById('painBeforeInput').value);
    try {
        const resp = await fetch('/api/session/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pain_before: painBefore })
        });
        const data = await resp.json();
        if (!data.ok) { alert('Error creating session: ' + (data.error || 'Unknown')); return; }
        sessionId = data.session_id;
    } catch (err) {
        alert('Network error creating session.'); console.error(err); return;
    }

    // Switch phases
    document.getElementById('phasePreSession').classList.remove('active');
    document.getElementById('phaseLiveSession').classList.add('active');

    // Start timers
    sessionStartTs = Date.now();
    exerciseStartTs = Date.now();
    sessionTimerInterval = setInterval(function() {
        if (!isPaused) document.getElementById('sessionTimer').textContent = fmt(Math.floor((Date.now() - sessionStartTs) / 1000));
    }, 1000);
    exerciseTimerInterval = setInterval(function() {
        if (!isPaused) document.getElementById('exerciseTimer').textContent = fmt(Math.floor((Date.now() - exerciseStartTs) / 1000));
    }, 1000);

    setsCompletedDict = {};
    currentExerciseCompleted = false; // Reset for first exercise
    
    console.log(`üöÄ Session started with ${WORKOUTS.length} exercises:`, WORKOUTS);
    console.log(`First exercise: "${WORKOUTS[0].name}", ${WORKOUTS[0].sets} sets x ${WORKOUTS[0].reps} reps`);
    
    updateRepCounter();
    updateExerciseSteps();
    updateSessionProgress();

    // Start camera + CV pipeline
    const camOk = await startWebcam();
    await callSessionStart();

    if (camOk) {
        await pollFeedback();
        startPolling();
    }
}

/* ===================== EXERCISE NAVIGATION ===================== */
async function nextExercise() {
    console.log(`üìã nextExercise called: currentExIndex=${currentExIndex}, WORKOUTS.length=${WORKOUTS.length}`);
    console.log(`  Current setsCompletedDict:`, setsCompletedDict);
    console.log(`  Current state: rep=${currentRep}/${targetReps}, set=${currentSet}/${targetSets}`);
    await saveCurrentExercise();
    console.log(`  After save, exerciseData[${currentExIndex}]:`, exerciseData[currentExIndex]);
    if (currentExIndex >= WORKOUTS.length - 1) {
        console.log('‚úÖ All exercises completed! Showing post-session.');
        showPostSession();
        return;
    }
    currentExIndex++;
    const w = WORKOUTS[currentExIndex];
    console.log(`‚û°Ô∏è Moving to exercise ${currentExIndex + 1}/${WORKOUTS.length}: ${w.name}`);
    targetSets = w.sets;
    targetReps = w.reps;
    currentRep = 0;
    currentSet = 1;
    currentExerciseCompleted = false; // Reset completion flag for new exercise
    allScores = [];
    setsCompletedDict = {};
    exerciseStartTs = Date.now();
    updateRepCounter();
    updateExerciseSteps();
    updateSessionProgress();
    addFeedback('info', 'Now: ' + w.name);
    const btn = document.getElementById('nextExerciseBtn');
    btn.style.animation = '';
    btn.innerHTML = (currentExIndex >= WORKOUTS.length - 1)
        ? '<i class="fa-solid fa-circle-check"></i> Finish Session'
        : '<span class="next-label">Next Exercise</span> <i class="fa-solid fa-arrow-right"></i>';

    // Re-init CV pipeline for new exercise
    await callSessionStart();
}

async function saveCurrentExercise() {
    console.log(`üíæ saveCurrentExercise: currentExIndex=${currentExIndex}, exerciseName=${WORKOUTS[currentExIndex].name}`);
    const w = WORKOUTS[currentExIndex];
    const avgQ = allScores.length > 0
        ? Math.round(allScores.reduce(function(a, b) { return a + b; }, 0) / allScores.length) : 0;
    const setsReq = {};
    for (let i = 1; i <= w.sets; i++) setsReq[String(i)] = w.reps;
    for (let i = 1; i <= w.sets; i++) {
        if (!(String(i) in setsCompletedDict)) setsCompletedDict[String(i)] = 0;
    }
    const exStartISO = new Date(exerciseStartTs).toISOString();
    const exEndISO = new Date().toISOString();
    const payload = {
        session_id: sessionId,
        workout_id: w.id,
        exercise_name: w.name,  // Send the user-selected exercise name
        exercise_start_time: exStartISO,
        exercise_end_time: exEndISO,
        quality_score: avgQ,
        sets_required: setsReq,
        sets_completed: Object.assign({}, setsCompletedDict)
    };
    exerciseData[currentExIndex] = payload;
    console.log(`  Saving data for exercise ${currentExIndex}:`, payload);
    try {
        const resp = await fetch('/api/session/exercise/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const result = await resp.json();
        console.log(`  Save response:`, result);
        if (result.ok) addFeedback('success', 'Exercise saved!');
    } catch (err) {
        console.error('Error saving exercise:', err);
    }
}

/* ===================== STOP / POST-SESSION ===================== */
async function stopSession() {
    if (!confirm('End this session and save your progress?')) return;
    await saveCurrentExercise();
    showPostSession();
}

function showPostSession() {
    console.log('üéâ Post-session: currentExIndex=' + currentExIndex + ', WORKOUTS.length=' + WORKOUTS.length);
    console.log('exerciseData:', exerciseData);
    console.log('WORKOUTS:', WORKOUTS);
    
    // Debug: Calculate and log detailed breakdown
    let totalReq = 0, totalDone = 0;
    WORKOUTS.forEach(function(w, i) {
        const exReq = w.sets * w.reps;
        totalReq += exReq;
        const saved = exerciseData[i];
        const done = saved ? Object.values(saved.sets_completed).reduce(function(a, b) { return a + b; }, 0) : 0;
        totalDone += done;
        console.log(`  Exercise ${i}: "${w.name}" - Required: ${exReq}, Done: ${done}, Saved: `, saved);
    });
    console.log(`Total: ${totalDone}/${totalReq} reps (${totalReq > 0 ? Math.round(totalDone/totalReq*100) : 0}%)`);
    
    stopPolling();
    stopCamera();
    stopSpeaking();
    clearInterval(sessionTimerInterval);
    clearInterval(exerciseTimerInterval);

    const overlay = document.createElement('div');
    overlay.className = 'post-overlay';
    
    // Build exercise summary
    let exerciseSummary = '<div style="margin-bottom:16px;"><h4 style="margin:0 0 8px;">Completed Exercises:</h4>';
    WORKOUTS.forEach(function(w, i) {
        const saved = exerciseData[i];
        const repsCompleted = saved ? Object.values(saved.sets_completed).reduce(function(a, b) { return a + b; }, 0) : 0;
        const status = repsCompleted >= (w.sets * w.reps) ? '‚úÖ' : '‚è±Ô∏è';
        exerciseSummary += '<div style="padding:4px 0;">' + status + ' ' + w.name + ': ' + repsCompleted + '/' + (w.sets * w.reps) + ' reps</div>';
    });
    exerciseSummary += '</div>';
    
    const progressPerc = calcSessionProgress();
    
    overlay.innerHTML = '<div class="post-card">' +
        '<h2><i class="fa-solid fa-circle-check"></i> Session Complete!</h2>' +
        '<p style="color:#666;">Overall progress: <strong>' + progressPerc + '%</strong></p>' +
        exerciseSummary +
        '<div class="pain-slider-group">' +
            '<label>Pain After (0-10): <span class="pain-value" id="painAfterVal">0</span></label>' +
            '<input type="range" id="painAfterInput" min="0" max="10" value="0" ' +
                'oninput="document.getElementById(\'painAfterVal\').textContent=this.value">' +
        '</div>' +
        '<div class="pain-slider-group">' +
            '<label>Effort Level (1-10): <span class="pain-value" id="effortVal">5</span></label>' +
            '<input type="range" id="effortInput" min="1" max="10" value="5" ' +
                'oninput="document.getElementById(\'effortVal\').textContent=this.value">' +
        '</div>' +
        '<div style="margin-bottom:14px;">' +
            '<label style="font-weight:600;display:block;margin-bottom:4px;">Notes (optional):</label>' +
            '<textarea id="postNotes" rows="2" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;"></textarea>' +
        '</div>' +
        '<button onclick="completeSession()" style="width:100%;padding:14px;font-size:1.05rem;font-weight:700;' +
            'border:none;border-radius:10px;background:linear-gradient(135deg,#007bff,#0056d2);color:#fff;cursor:pointer;">' +
            'Save &amp; View Summary</button>' +
        '</div>';
    document.body.appendChild(overlay);
}

async function completeSession() {
    const painAfter = parseInt(document.getElementById('painAfterInput').value);
    const effort = parseInt(document.getElementById('effortInput').value);
    const notes = document.getElementById('postNotes').value;
    try {
        const resp = await fetch('/api/session/complete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                session_id: sessionId,
                pain_after: painAfter,
                effort_level: effort,
                notes: notes
            })
        });
        const result = await resp.json();
        if (result.ok) {
            window.location.href = '/patient/summary/' + sessionId;
        } else {
            alert('Error: ' + (result.error || 'Unknown'));
        }
    } catch (err) {
        console.error(err);
        alert('Network error saving session.');
    }
}

/* ===================== MISC CONTROLS ===================== */
function togglePause() {
    isPaused = !isPaused;
    document.getElementById('pauseBtn').innerHTML = isPaused
        ? '<i class="fa-solid fa-play"></i> Resume'
        : '<i class="fa-solid fa-pause"></i> Pause';
    addFeedback('info', isPaused ? 'Session paused' : 'Session resumed');
    if (isPaused) stopSpeaking();
}

/* Language change re-inits CV pipeline */
document.getElementById('languageSelect').addEventListener('change', async function() {
    stopSpeaking();
    if (sessionId) await callSessionStart();
});

window.addEventListener('beforeunload', function() {
    stopCamera();
    stopPolling();
});
</script>
{% endblock %}
