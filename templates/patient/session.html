{% extends 'base.html' %}

{% block title %}Rehab Session - Home Rehab Coach{% endblock %}

{% block header %}
<header class="header">
    <h1>üèãÔ∏è Rehab Session</h1>
    <nav class="nav-links">
        <a href="{{ url_for('patient_dashboard') }}">‚Üê Back to Dashboard</a>
    </nav>
</header>
{% endblock %}

{% block content %}
<div class="session-layout">
    <!-- Video Panel -->
    <div class="video-panel">
        <div class="skeleton-overlay">
            <strong>Skeleton Tracking: ON</strong><br>
            <small>Pose detection active</small>
        </div>

        <!-- ‚úÖ Replace placeholder with REAL webcam video -->
        <div class="video-placeholder" style="padding: 0; overflow: hidden;">
            <video id="webcamVideo" autoplay playsinline muted style="width:100%; height:100%; object-fit: cover; background:#000;"></video>
            <!-- optional: show overlay text if camera fails -->
            <div id="camErrorOverlay" style="display:none; position:absolute; inset:0; align-items:center; justify-content:center; flex-direction:column; color:#fff;">
                <div class="icon">üìπ</div>
                <p>Live Webcam Feed</p>
                <p style="font-size: 0.8rem; opacity: 0.7;">Allow camera access to start</p>
            </div>
        </div>
    </div>

    <!-- Feedback Panel -->
    <div class="feedback-panel">
        <!-- Rep Counter (still placeholder) -->
        <div class="rep-counter">
            <div class="count">7 / 10</div>
            <div class="label">Reps (Set 2 of 3)</div>
        </div>

        <!-- ‚úÖ Form Status (dynamic) -->
        <div class="form-status">
            <h4 style="margin-bottom: 10px;">Form Status</h4>

            <!-- ‚úÖ single indicator (remove duplicates) -->
            <div id="statusIndicator" class="status-indicator correct">
                ‚úì CORRECT FORM
            </div>

            <div style="margin-top: 10px; text-align:center; color:#666;">
                Score: <span id="frameScoreText">--</span> / 50
            </div>
        </div>

        <!-- ‚úÖ Real-time Feedback (dynamic) -->
        <div class="error-messages">
            <h4>Real-time Feedback</h4>

            <!-- This will be replaced by JS -->
            <div id="feedbackList">
                <div class="error-item">
                    Waiting for feedback...
                </div>
            </div>
        </div>

        <!-- Audio Indicator (still placeholder UI) -->
        <div class="audio-indicator">
            <div class="audio-icon">üîä</div>
            <div>
                <strong>Voice Feedback: ON</strong><br>
                <small>Audio cues are active</small>
            </div>
        </div>

        <!-- Exercise Info -->
        <div class="card" style="padding: 15px;">
            <h4>Current Exercise</h4>
            <p style="color: #666; margin-top: 5px;" id="exerciseNameText">Knee Extension</p>
            <p style="font-size: 0.85rem; margin-top: 10px;">
                Target: 3 sets √ó 10 reps<br>
                ROM Target: 90¬∞ flexion
            </p>
        </div>

        <!-- Session Controls -->
        <div class="session-controls">
            <button class="btn" style="flex: 1;">‚è∏Ô∏è Pause</button>
            <button class="btn btn-danger" style="flex: 1;">‚èπÔ∏è Stop Session</button>
        </div>

        <!-- Next Step -->
        <a href="{{ url_for('pain_checkin') }}" class="btn btn-success" style="text-align: center;">
            Complete Set ‚Üí Check-in
        </a>
    </div>
</div>

<!-- ‚úÖ JS: camera + polling + UI updates -->
<script>
const VIDEO = document.getElementById("webcamVideo");
const camErrorOverlay = document.getElementById("camErrorOverlay");

const statusIndicator = document.getElementById("statusIndicator");
const scoreSpan = document.getElementById("frameScoreText");
const feedbackBox = document.getElementById("feedbackList");
const exerciseNameText = document.getElementById("exerciseNameText");

const canvas = document.createElement("canvas");
const ctx = canvas.getContext("2d");

// You can wire this later to a dropdown / backend variable
const EXERCISE_NAME = exerciseNameText ? exerciseNameText.textContent.trim() : "exercise";
const THRESHOLD = 30.0;
const COOLDOWN_SECONDS = 10;
const POLL_MS = 2000;

async function startWebcam() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        VIDEO.srcObject = stream;
        await VIDEO.play();
        if (camErrorOverlay) camErrorOverlay.style.display = "none";
        return true;
    } catch (err) {
        console.error("Camera error:", err);
        if (camErrorOverlay) {
            camErrorOverlay.style.display = "flex";
        }
        return false;
    }
}

async function startSession() {
    await fetch("/api/session/start", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            threshold: THRESHOLD,
            exercise_name: EXERCISE_NAME,
            cooldown_seconds: COOLDOWN_SECONDS
        })
    });
}

function grabFrameDataURL() {
    const w = VIDEO.videoWidth, h = VIDEO.videoHeight;
    if (!w || !h) return null;
    canvas.width = w; canvas.height = h;
    ctx.drawImage(VIDEO, 0, 0, w, h);
    return canvas.toDataURL("image/jpeg", 0.85);
}

function setStatus(status, score) {
    scoreSpan.textContent = Number(score || 0).toFixed(2);

    // reset classes
    statusIndicator.classList.remove("correct", "incorrect");

    if (status === "CORRECT") {
        statusIndicator.classList.add("correct");
        statusIndicator.textContent = "‚úì CORRECT FORM";
    } else if (status === "WRONG") {
        statusIndicator.classList.add("incorrect");
        statusIndicator.textContent = "‚úó FORM NEEDS ADJUSTMENT";
    } else if (status === "NO_POSE") {
        statusIndicator.classList.add("incorrect");
        statusIndicator.textContent = "‚Ä¶ POSE NOT DETECTED";
    } else {
        statusIndicator.classList.add("incorrect");
        statusIndicator.textContent = "‚Ä¶ PROCESSING";
    }
}

function renderFeedback(items) {
    feedbackBox.innerHTML = "";

    if (!items || items.length === 0) {
        const div = document.createElement("div");
        div.className = "error-item";
        div.textContent = "No new feedback.";
        feedbackBox.appendChild(div);
        return;
    }

    items.slice(0, 4).forEach((txt, idx) => {
        const div = document.createElement("div");
        div.className = "error-item";
        div.textContent = "‚ö†Ô∏è " + txt;
        feedbackBox.appendChild(div);
    });
}

async function pollFeedback() {
    const frame_b64 = grabFrameDataURL();
    if (!frame_b64) return;

    const res = await fetch("/api/live_feedback", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ frame_b64 })
    });

    const out = await res.json();
    setStatus(out.form_status, out.frame_score);
    renderFeedback(out.llm_feedback);
}

(async function init() {
    const camOk = await startWebcam();
    if (!camOk) return;

    await startSession();
    setInterval(pollFeedback, POLL_MS);
})();
</script>

{% endblock %}