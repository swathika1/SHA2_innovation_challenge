{% extends 'base.html' %}

{% block title %}My Consultations - Home Rehab Coach{% endblock %}

{% block header %}
<header class="header">
    <h1><a href="{{ url_for('patient_dashboard') }}">üè† Home Rehab Coach</a></h1>
    <nav class="nav-links">
        <a href="{{ url_for('patient_dashboard') }}">Dashboard</a>
        <a href="{{ url_for('patient_appointments') }}" class="active">Consultations</a>
        <div class="nav-user">
            <button class="nav-user-btn" title="Account">üë§</button>
            <div class="nav-user-dropdown">
                <div class="nav-user-dropdown-inner">
                    <div class="dropdown-header">Signed in as<strong>{{ user.name if user else 'Patient' }}</strong></div>
                    <a href="{{ url_for('patient_profile') }}"><span class="dropdown-icon">ÔøΩ</span> My Profile</a>
                    <div class="dropdown-divider"></div>
                    <a href="{{ url_for('logout') }}" class="dropdown-logout"><span class="dropdown-icon">üö™</span> Logout</a>
                </div>
            </div>
        </div>
    </nav>
</header>
{% endblock %}

{% block content %}
<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category }} {% if category == 'error' %}alert-error{% else %}alert-success{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<div class="appointments-container">
    <!-- Smart Scheduling: Optimized Doctor Recommendations -->
    <div class="card" style="margin-bottom: 20px; border: 2px solid #007bff;">
        <div class="card-header" style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); color: #1565c0;">
            Smart Scheduling - Recommended Doctors
        </div>
        <p style="color: #666; font-size: 0.95rem; padding: 0 5px; margin-bottom: 15px;">
            Based on your rehab progress and availability, here are the best appointment options for you:
        </p>
        <button id="btn-get-recommendations" class="btn btn-primary" style="width: 100%; margin-bottom: 15px;">
            Get My Best Appointment Options
        </button>
        <p id="loading-text" style="display: none; text-align: center; color: #666;">
            Finding the best appointments for you...
        </p>

        <!-- Notification Banner (always present for JS) -->
        <div id="notification-banner" style="display: none; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <strong id="notif-level"></strong>
            <span id="notif-message"></span>
        </div>

        <!-- Recommendations List -->
        <div id="recommendations-panel" style="display: none;">
            <div style="background: #e3f2fd; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                <strong style="color: #1565c0;">Top 3 Recommendations</strong>
                <p style="font-size: 0.9rem; color: #666; margin: 5px 0 0 0;">
                    Click "Book" on any option to auto-fill the booking form below
                </p>
            </div>
            <div id="recommendations-list"></div>
        </div>
    </div>

    <!-- Book Appointment Form (auto-filled by recommendations) -->
    <div id="booking-form-card" class="card" style="margin-bottom: 20px;">
        <div class="card-header">Book Your Appointment</div>
        <form method="POST" action="{{ url_for('patient_book_appointment') }}">
            <div class="form-group">
                <label>Doctor</label>
                <input type="text" id="book-doctor" name="doctor_name" class="form-control" placeholder="Select a recommendation above" readonly required>
            </div>
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="book-date" name="appointment_date" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Time</label>
                <select id="book-time" name="appointment_time" class="form-control" required>
                    <option value="">-- Select Time --</option>
                    <option value="09:00">9:00 AM</option>
                    <option value="09:30">9:30 AM</option>
                    <option value="10:00">10:00 AM</option>
                    <option value="10:30">10:30 AM</option>
                    <option value="11:00">11:00 AM</option>
                    <option value="11:30">11:30 AM</option>
                    <option value="12:00">12:00 PM</option>
                    <option value="14:00">2:00 PM</option>
                    <option value="14:30">2:30 PM</option>
                    <option value="15:00">3:00 PM</option>
                    <option value="15:30">3:30 PM</option>
                    <option value="16:00">4:00 PM</option>
                    <option value="16:30">4:30 PM</option>
                    <option value="17:00">5:00 PM</option>
                </select>
            </div>
            <div class="form-group">
                <label>Duration</label>
                <select name="duration" class="form-control">
                    <option value="15">15 minutes</option>
                    <option value="30" selected>30 minutes</option>
                    <option value="45">45 minutes</option>
                    <option value="60">60 minutes</option>
                </select>
            </div>
            <div class="form-group">
                <label>Notes (Optional)</label>
                <textarea name="notes" class="form-control" rows="2" placeholder="What would you like to discuss?"></textarea>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">
                Request Appointment
            </button>
            <p style="font-size: 0.85rem; color: #666; text-align: center; margin-top: 10px;">
                Your doctor will confirm the appointment
            </p>
        </form>
    </div>

    <!-- Upcoming Appointments -->
    <div class="card">
        <div class="card-header">ÔøΩ Upcoming Video Consultations</div>

        {% if appointments %}
            {% for apt in appointments %}
            <div class="appointment-card">
                <div class="appointment-info">
                    <div class="appointment-date">
                        <div class="date-day">{{ apt.appointment_date.split('-')[2] if apt.appointment_date else '' }}</div>
                        <div class="date-month">{{ ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][apt.appointment_date.split('-')[1]|int - 1] if apt.appointment_date else '' }}</div>
                    </div>
                    <div class="appointment-details">
                        <h3>{{ apt.doctor_name }}</h3>
                        <p class="time">üïê {{ apt.appointment_time }} ({{ apt.duration }} min)</p>
                        {% if apt.notes %}
                        <p class="notes">üìù {{ apt.notes }}</p>
                        {% endif %}
                    </div>
                </div>
                <div class="appointment-actions">
                    <a href="{{ url_for('video_call', appointment_id=apt.id) }}" class="btn btn-success btn-large">
                        üé• Join Video Call
                    </a>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <div class="empty-icon">üìÖ</div>
                <h3>No Upcoming Appointments</h3>
                <p>Your doctor will schedule video consultations as needed.</p>
            </div>
        {% endif %}
    </div>
    
    <!-- Tips Card -->
    <div class="card" style="margin-top: 20px;">
        <div class="card-header">ÔøΩ Video Call Tips</div>
        <div class="tips-list">
            <div class="tip-item">
                <span class="tip-icon">üì∂</span>
                <span>Ensure you have a stable internet connection</span>
            </div>
            <div class="tip-item">
                <span class="tip-icon">üé§</span>
                <span>Test your microphone and camera before the call</span>
            </div>
            <div class="tip-item">
                <span class="tip-icon">üîá</span>
                <span>Find a quiet, private space for your consultation</span>
            </div>
            <div class="tip-item">
                <span class="tip-icon">üí°</span>
                <span>Good lighting helps your doctor see you clearly</span>
            </div>
            <div class="tip-item">
                <span class="tip-icon">üìã</span>
                <span>Have your questions ready beforehand</span>
            </div>
        </div>
    </div>
    
    <!-- Past Appointments -->
    {% if past_appointments %}
    <div class="card" style="margin-top: 20px;">
        <div class="card-header">ÔøΩ Past Appointments</div>
        <div class="past-appointments">
            {% for apt in past_appointments %}
            <div class="past-item">
                <div class="past-info">
                    <strong>{{ apt.doctor_name }}</strong>
                    <span class="past-date">{{ apt.appointment_date }}</span>
                </div>
                <span class="status-badge {{ apt.status }}">
                    {% if apt.status == 'completed' %}‚úì Completed{% else %}‚úï Cancelled{% endif %}
                </span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<style>
    .appointments-container {
        max-width: 900px;
        margin: 0 auto;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #333;
    }
    .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
    }
    .form-control:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
    }
    .recommendation-item {
        background: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.2s;
    }
    .recommendation-item:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transform: translateY(-1px);
    }
    .score-badge {
        background: #e3f2fd;
        color: #1565c0;
        padding: 6px 14px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.85rem;
    }
    
    .appointment-card {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 12px;
        margin-bottom: 15px;
        border-left: 4px solid #28a745;
    }
    
    .appointment-info {
        display: flex;
        align-items: center;
        gap: 20px;
    }
    
    .appointment-date {
        text-align: center;
        background: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .date-day {
        font-size: 2rem;
        font-weight: bold;
        color: #007bff;
        line-height: 1;
    }
    
    .date-month {
        font-size: 0.9rem;
        color: #666;
        text-transform: uppercase;
    }
    
    .appointment-details h3 {
        margin: 0 0 5px 0;
        color: #333;
    }
    
    .appointment-details .time {
        color: #666;
        margin: 0 0 5px 0;
    }
    
    .appointment-details .notes {
        color: #888;
        font-size: 0.9rem;
        font-style: italic;
        margin: 0;
    }
    
    .appointment-actions {
        flex-shrink: 0;
    }
    
    .btn-large {
        padding: 15px 30px;
        font-size: 1.1rem;
    }
    
    .btn-success {
        background: #28a745;
        color: white;
    }
    
    .btn-success:hover {
        background: #218838;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
    }
    
    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #666;
    }
    
    .empty-icon {
        font-size: 4rem;
        margin-bottom: 15px;
    }
    
    .empty-state h3 {
        margin: 0 0 10px 0;
        color: #333;
    }
    
    .empty-state p {
        margin: 0;
    }
    
    .tips-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    .tip-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 6px;
    }
    
    .tip-icon {
        font-size: 1.3rem;
    }
    
    .past-appointments {
        display: flex;
        flex-direction: column;
    }
    
    .past-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #eee;
    }
    
    .past-item:last-child {
        border-bottom: none;
    }
    
    .past-info {
        display: flex;
        flex-direction: column;
        gap: 3px;
    }
    
    .past-date {
        color: #666;
        font-size: 0.85rem;
    }
    
    .status-badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .status-badge.completed {
        background: #d4edda;
        color: #155724;
    }
    
    .status-badge.cancelled {
        background: #f8d7da;
        color: #721c24;
    }
    
    .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    @media (max-width: 600px) {
        .appointment-card {
            flex-direction: column;
            gap: 15px;
            text-align: center;
        }
        
        .appointment-info {
            flex-direction: column;
        }
        
        .btn-large {
            width: 100%;
        }
    }
</style>

<script>
    // DOM references
    const btnGetRecs = document.getElementById('btn-get-recommendations');
    const loadingText = document.getElementById('loading-text');
    const notifBanner = document.getElementById('notification-banner');
    const notifLevel = document.getElementById('notif-level');
    const notifMessage = document.getElementById('notif-message');
    const recsPanel = document.getElementById('recommendations-panel');
    const recsList = document.getElementById('recommendations-list');
    const bookingFormCard = document.getElementById('booking-form-card');

    // Fetch and display recommendations
    btnGetRecs.addEventListener('click', function() {
        loadingText.style.display = 'block';
        btnGetRecs.disabled = true;
        notifBanner.style.display = 'none';
        recsPanel.style.display = 'none';

        fetch('/api/patient/recommendations')
            .then(response => response.json())
            .then(data => {
                loadingText.style.display = 'none';
                btnGetRecs.disabled = false;

                // Defensive: check notification elements exist
                if (data.notification) {
                    const notif = data.notification;
                    if (notifBanner && notifLevel && notifMessage) {
                        notifLevel.textContent = notif.level === 'critical' ? 'CRITICAL: ' : 'NOTICE: ';
                        notifMessage.textContent = notif.message;
                        notifBanner.className = notif.level === 'critical' ? 'critical' : 'concerning';
                        notifBanner.style.display = 'block';
                    }
                }

                // Display recommendations
                const recs = data.recommendations || [];
                if (recs.length === 0) {
                    recsList.innerHTML = '<p style="color: #666; padding: 15px; text-align: center;">No appointments available at this time. Please try again later.</p>';
                } else {
                    let html = '';
                    recs.forEach(rec => {
                        html += `
                            <div class="recommendation-item">
                                <div class="recommendation-info">
                                    <strong>#${rec.rank} - ${rec.doctor_label}</strong>
                                    <p>üìÖ ${rec.timeslot_label} | üìç ${rec.dist_km} km away</p>
                                </div>
                                <div class="recommendation-actions">
                                    <span class="score-badge">Score: ${rec.score.toFixed(2)}</span>
                                    <button class="btn btn-success"
                                            data-doctor="${rec.doctor_label}"
                                            data-timeslot="${rec.timeslot_label}"
                                            onclick="bookRecommendation(this)">
                                        Book
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    recsList.innerHTML = html;
                }

                recsPanel.style.display = 'block';
                btnGetRecs.disabled = false;
            })
            .catch(err => {
                loadingText.style.display = 'none';
                alert('Failed to load recommendations. Please try again.');
                console.error('Error:', err);
                btnGetRecs.disabled = false;
            });
    });

    // Book a recommendation - auto-fill form
    function bookRecommendation(btn) {
        const doctorLabel = btn.getAttribute('data-doctor');
        const timeslotLabel = btn.getAttribute('data-timeslot');

        // Visual feedback
        document.querySelectorAll('.recommendation-item').forEach(item => {
            item.style.border = '1px solid #ddd';
        });
        btn.closest('.recommendation-item').style.border = '2px solid #28a745';

        // Parse timeslot (e.g., "Mon 9:00 AM")
        const match = timeslotLabel.match(/^(\w+)\s+(\d+:\d+)\s*(AM|PM)/i);
        if (match) {
            const dayAbbrev = match[1];
            const time12hr = match[2];
            const ampm = match[3].toUpperCase();

            // Convert to 24-hour format
            const timeParts = time12hr.split(':');
            let hour = parseInt(timeParts[0]);
            const minute = timeParts[1];

            if (ampm === 'PM' && hour !== 12) {
                hour += 12;
            } else if (ampm === 'AM' && hour === 12) {
                hour = 0;
            }

            const timeStr = hour.toString().padStart(2, '0') + ':' + minute;

            // Calculate date from day of week
            const dayMap = {
                'Mon': 1, 'Monday': 1,
                'Tue': 2, 'Tuesday': 2,
                'Wed': 3, 'Wednesday': 3,
                'Thu': 4, 'Thursday': 4,
                'Fri': 5, 'Friday': 5,
                'Sat': 6, 'Saturday': 6,
                'Sun': 0, 'Sunday': 0
            };

            const targetDay = dayMap[dayAbbrev];
            if (targetDay !== undefined) {
                const today = new Date();
                const currentDay = today.getDay();
                let daysUntilTarget = targetDay - currentDay;

                if (daysUntilTarget < 0) {
                    daysUntilTarget += 7;
                } else if (daysUntilTarget === 0) {
                    const now = new Date();
                    const targetTime = new Date(now);
                    targetTime.setHours(hour, parseInt(minute), 0, 0);
                    if (targetTime <= now) {
                        daysUntilTarget = 7;
                    }
                }

                const targetDate = new Date(today);
                targetDate.setDate(today.getDate() + daysUntilTarget);

                const dateStr = targetDate.getFullYear() + '-' +
                    String(targetDate.getMonth() + 1).padStart(2, '0') + '-' +
                    String(targetDate.getDate()).padStart(2, '0');

                // Fill form
                document.getElementById('book-doctor').value = doctorLabel;
                document.getElementById('book-date').value = dateStr;
                document.getElementById('book-time').value = timeStr;

                // Scroll to form
                bookingFormCard.scrollIntoView({ behavior: 'smooth' });

                // Flash form
                bookingFormCard.style.transition = 'background-color 0.3s';
                bookingFormCard.style.backgroundColor = '#d4edda';
                setTimeout(() => {
                    bookingFormCard.style.backgroundColor = '';
                }, 1000);
            }
        }

        // Scroll + flash
        bookingFormCard.scrollIntoView({ behavior: 'smooth' });
        bookingFormCard.style.transition = 'background-color 0.3s';
        bookingFormCard.style.backgroundColor = '#d4edda';
        setTimeout(function() { bookingFormCard.style.backgroundColor = ''; }, 1000);
    }

    // Set minimum date to today
    document.addEventListener('DOMContentLoaded', function() {
        var dateInput = document.getElementById('book-date');
        if (dateInput) {
            var today = new Date().toISOString().split('T')[0];
            dateInput.setAttribute('min', today);
        }
    });
</script>
{% endblock %}
