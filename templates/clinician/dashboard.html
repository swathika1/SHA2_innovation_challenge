{% extends 'base.html' %}

{% block title %}Clinician Dashboard - Home Rehab Coach{% endblock %}

{% block header %}
<header class="header">
    <h1><a href="{{ url_for('clinician_dashboard') }}"><i class="fa-solid fa-user-doctor"></i> RehabCoach</a></h1>
    <nav class="nav-links">
        <a href="{{ url_for('clinician_dashboard') }}" class="active">Dashboard</a>
        <a href="{{ url_for('plan_editor') }}">Plan Editor</a>
        <a href="{{ url_for('consultation') }}">Consultations</a>
        <div class="nav-user">
            <button class="nav-user-btn" title="Account"><i class="fa-solid fa-user"></i></button>
            <div class="nav-user-dropdown">
                <div class="nav-user-dropdown-inner">
                    <div class="dropdown-header">Signed in as<strong>Dr. {{ session.get('user_name', 'Doctor') }}</strong></div>
                    <a href="{{ url_for('clinician_profile') }}"><span class="dropdown-icon"><i class="fa-solid fa-user"></i></span> My Profile</a>
                    <div class="dropdown-divider"></div>
                    <a href="{{ url_for('logout') }}" class="dropdown-logout"><span class="dropdown-icon"><i class="fa-solid fa-right-from-bracket"></i></span> Logout</a>
                </div>
            </div>
        </div>
    </nav>
</header>
{% endblock %}

{% block content %}
<div class="dashboard-header">
    <h2>Patient Overview</h2>
    <span>Welcome, Dr. {{ session.get('user_name', 'Doctor') }}</span>
</div>

<!-- Quick Stats -->
<div class="stats-row">
    <div class="stat-box">
        <div class="stat-value">{{ total_patients }}</div>
        <div class="stat-label">Total Patients</div>
    </div>
    <div class="stat-box" style="border: 2px solid #dc3545;">
        <div class="stat-value" style="color: #dc3545;">{{ needs_attention }}</div>
        <div class="stat-label">Needs Attention</div>
    </div>
    <div class="stat-box">
        <div class="stat-value">{{ avg_adherence }}%</div>
        <div class="stat-label">Avg. Adherence</div>
    </div>
    <div class="stat-box">
        <div class="stat-value">{{ upcoming_appointments }}</div>
        <div class="stat-label">Upcoming Calls</div>
    </div>
</div>

<!-- Quick Actions -->
<div style="display: flex; gap: 15px; margin-bottom: 20px;">
    <a href="{{ url_for('consultation') }}" class="btn" style="background: #17a2b8;"><i class="fa-solid fa-video"></i> Schedule Video Call</a>
    <a href="{{ url_for('plan_editor') }}" class="btn" style="background: #28a745;"><i class="fa-solid fa-pen-to-square"></i> Create Rehab Plan</a>
</div>

<!-- Filter Bar -->
<div class="filter-bar">
    <button class="filter-btn active">All Patients ({{ total_patients }})</button>
    <button class="filter-btn" style="background: #f8d7da; border-color: #dc3545; color: #721c24;"><i class="fa-solid fa-triangle-exclamation"></i> Needs Attention ({{ needs_attention }})</button>
</div>

<!-- Patient List -->
<div class="patient-list">
    {% if patients %}
        {% for patient in patients %}
        <div class="patient-item">
            <div class="patient-info">
                <h4>{{ patient.name }}</h4>
                <span class="meta">ID: #{{ patient.id }} | {{ patient.condition or 'General Rehab' }} | Week {{ patient.current_week or 1 }}</span>
            </div>
            <div style="display: flex; align-items: center; gap: 15px;">
                {% if patient.adherence_rate < 50 %}
                    <span class="risk-flag high"><i class="fa-solid fa-triangle-exclamation"></i> Low Adherence</span>
                {% elif patient.avg_pain_level and patient.avg_pain_level > 6 %}
                    <span class="risk-flag medium"><i class="fa-solid fa-triangle-exclamation"></i> Pain Spike</span>
                {% elif patient.avg_quality_score and patient.avg_quality_score < 60 %}
                    <span class="risk-flag medium"><i class="fa-solid fa-triangle-exclamation"></i> Form Quality Low</span>
                {% else %}
                    <span class="risk-flag low"><i class="fa-solid fa-circle-check"></i> On Track</span>
                {% endif %}
                <span style="color: #666;">{{ patient.adherence_rate or 0 }}% adherence</span>
                <a href="{{ url_for('patient_detail', patient_id=patient.id) }}" class="btn">View Details</a>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="patient-item" style="text-align: center; padding: 40px;">
            <h4>No patients assigned yet</h4>
            <p style="color: #666;">When patients register and select you as their doctor, they will appear here.</p>
        </div>
    {% endif %}
</div>

<style>
.stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}
.stat-box {
    background: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.stat-value {
    font-size: 2rem;
    font-weight: bold;
    color: #007bff;
}
.stat-label {
    color: #666;
    font-size: 0.9rem;
}
.filter-bar {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}
.filter-btn {
    padding: 10px 15px;
    border: 1px solid #ddd;
    border-radius: 5px;
    background: white;
    cursor: pointer;
}
.filter-btn.active {
    background: #007bff;
    color: white;
    border-color: #007bff;
}
.patient-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.patient-item {
    background: white;
    padding: 20px;
    border-radius: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    flex-wrap: wrap;
    gap: 10px;
}
.patient-info h4 {
    margin: 0 0 5px 0;
}
.patient-info .meta {
    color: #666;
    font-size: 0.9rem;
}
.risk-flag {
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 0.85rem;
    font-weight: bold;
}
.risk-flag.high {
    background: #f8d7da;
    color: #721c24;
}
.risk-flag.medium {
    background: #fff3cd;
    color: #856404;
}
.risk-flag.low {
    background: #d4edda;
    color: #155724;
}
</style>
{% endblock %}