{% extends 'base.html' %}

{% block title %}Video Call - Home Rehab Coach{% endblock %}

{% block header %}
<header class="header">
    <h1>üìπ Video Consultation</h1>
    <nav class="nav-links">
        {% if is_doctor %}
            <a href="{{ url_for('clinician_dashboard') }}">‚Üê Back to Dashboard</a>
        {% else %}
            <a href="{{ url_for('patient_dashboard') }}">‚Üê Back to Dashboard</a>
        {% endif %}
    </nav>
</header>
{% endblock %}

{% block content %}
<div class="video-call-container">
    <!-- Call Info Header -->
    <div class="card" style="margin-bottom: 20px; padding: 15px;">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
            <div>
                <h3 style="margin: 0;">
                    {% if is_doctor %}
                        Patient: {{ appointment.patient_name }}
                    {% else %}
                        Doctor: {{ appointment.doctor_name }}
                    {% endif %}
                </h3>
                <p style="margin: 5px 0 0; color: #666;">
                    {{ appointment.appointment_date }} at {{ appointment.appointment_time }}
                    {% if appointment.condition %}
                        | Condition: {{ appointment.condition }}
                    {% endif %}
                </p>
            </div>
            <div style="text-align: right;">
                <span class="status-badge" style="background: #28a745; color: white; padding: 5px 10px; border-radius: 4px;">
                    üü¢ Ready to Connect
                </span>
            </div>
        </div>
    </div>
    
    <!-- Video Call Section -->
    <div class="card" style="padding: 20px;">
        <h3>Join Video Call</h3>
        
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
            <p style="margin-bottom: 15px;">
                <strong>Room ID:</strong> <code style="background: #e9ecef; padding: 2px 8px; border-radius: 4px;">{{ room_id }}</code>
            </p>
            
            {% if is_doctor %}
                <!-- Doctor View -->
                <div style="background: #d4edda; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <p style="margin: 0; color: #155724;">
                        <strong>üë®‚Äç‚öïÔ∏è You are the HOST</strong><br>
                        <small>Click the button below to start the meeting. The patient will be able to join once you're in.</small>
                    </p>
                </div>
                <button onclick="openJitsiAsHost()" class="btn btn-primary btn-large" style="width: 100%;">
                    üé¨ Start Meeting as Host
                </button>
            {% else %}
                <!-- Patient View -->
                <div style="background: #cce5ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <p style="margin: 0; color: #004085;">
                        <strong>üßë‚Äçü¶Ω You are joining as PARTICIPANT</strong><br>
                        <small>Click the button below to join. Make sure your doctor has started the meeting first.</small>
                    </p>
                </div>
                <button onclick="openJitsiAsPatient()" class="btn btn-primary btn-large" style="width: 100%;">
                    üìû Join Meeting
                </button>
            {% endif %}
        </div>
        
        <!-- Patient Info for Doctor -->
        {% if is_doctor and appointment.condition %}
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
            <h4>Patient Quick Stats</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-top: 10px;">
                <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold;">{{ appointment.adherence_rate or 0 }}%</div>
                    <div style="font-size: 0.8rem; color: #666;">Adherence</div>
                </div>
                <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold;">{{ appointment.avg_pain_level or 0 }}/10</div>
                    <div style="font-size: 0.8rem; color: #666;">Avg Pain</div>
                </div>
                <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold;">{{ appointment.avg_quality_score or 0 }}%</div>
                    <div style="font-size: 0.8rem; color: #666;">Form Quality</div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Instructions -->
        <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px;">
            <h4 style="margin-top: 0;">üìã Instructions</h4>
            <ul style="margin: 0; padding-left: 20px;">
                <li>Make sure your camera and microphone are working</li>
                <li>Use a well-lit room for better visibility</li>
                <li>Have a stable internet connection</li>
                <li>The call will open in a new window</li>
            </ul>
        </div>
    </div>
    
    <!-- Notes Section -->
    {% if appointment.notes %}
    <div class="card" style="margin-top: 20px; padding: 15px;">
        <h4>üìù Appointment Notes</h4>
        <p style="margin: 0; color: #666;">{{ appointment.notes }}</p>
    </div>
    {% endif %}
</div>

<script>
    // Jitsi configuration - Using meet.ffmuc.net (free, no auth required)
    const jitsiDomain = "meet.ffmuc.net";
    const roomId = "{{ room_id }}";
    const userName = "{{ user_name }}";
    const isDoctor = {{ 'true' if is_doctor else 'false' }};
    
    function openJitsiAsHost() {
        // Doctor opens as host/moderator
        const url = `https://${jitsiDomain}/${roomId}#userInfo.displayName="${userName}"&config.startWithAudioMuted=false&config.startWithVideoMuted=false`;
        window.open(url, '_blank', 'width=1200,height=800');
    }
    
    function openJitsiAsPatient() {
        // Patient joins the existing room
        const url = `https://${jitsiDomain}/${roomId}#userInfo.displayName="${userName}"&config.startWithAudioMuted=false&config.startWithVideoMuted=false`;
        window.open(url, '_blank', 'width=1200,height=800');
    }
</script>

<style>
.video-call-container {
    max-width: 800px;
    margin: 0 auto;
}
</style>
{% endblock %}
