{% extends 'base.html' %}

{% block title %}Video Call - Home Rehab Coach{% endblock %}

{% block header %}
<header class="header">
    <h1><i class="fa-solid fa-video"></i> Video Consultation</h1>
</header>
{% endblock %}

{% block content %}
<div class="video-call-container">
    <!-- Call Info Header -->
    <div class="card" style="margin-bottom: 20px; padding: 15px;">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
            <div>
                <h3 style="margin: 0;">
                    {% if is_doctor %}
                        Patient: {{ appointment.patient_name }}
                    {% else %}
                        Doctor: {{ appointment.doctor_name }}
                    {% endif %}
                </h3>
                <p style="margin: 5px 0 0; color: #666;">
                    {{ appointment.appointment_date }} at {{ appointment.appointment_time }}
                    {% if appointment.condition %}
                        | Condition: {{ appointment.condition }}
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
    
    <!-- Video Call Section - Embedded Iframe -->
    <div id="jitsi-container" style="width: 100%; height: 600px; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <!-- Jitsi will load here -->
    </div>
    
    <!-- Call Instructions -->
    <div style="margin-top: 20px; padding: 15px; background: #cce5ff; border-radius: 8px; text-align: center;">
        <p style="margin: 0; color: #004085;">
            <strong><i class="fa-solid fa-phone"></i> Call is starting...</strong><br>
            <small>When you're done, click the red hang-up button in the call. You'll be automatically returned to your dashboard.</small>
        </p>
    </div>
</div>

<script>
    // Jitsi configuration
    const jitsiDomain = "meet.ffmuc.net";
    const roomId = "{{ room_id }}";
    const userName = "{{ user_name }}";
    const isDoctor = {{ 'true' if is_doctor else 'false' }};
    
    // Configure Jitsi options
    const options = {
        roomName: roomId,
        width: '100%',
        height: '100%',
        parentNode: document.getElementById('jitsi-container'),
        configOverwrite: {
            startWithAudioMuted: false,
            startWithVideoMuted: false,
            prejoinPageEnabled: false
        },
        interfaceConfigOverwrite: {
            SHOW_BRAND_WATERMARK: false,
            SHOW_JITSI_WATERMARK: false,
            DEFAULT_BACKGROUND: '#ffffff'
        },
        userInfo: {
            displayName: userName
        },
        onload: function() {
            console.log('Jitsi iframe loaded');
        }
    };
    
    // Load Jitsi API script
    const jitsiScript = document.createElement('script');
    jitsiScript.src = `https://${jitsiDomain}/external_api.js`;
    jitsiScript.async = true;
    document.head.appendChild(jitsiScript);
    
    // Initialize Jitsi when API is loaded
    jitsiScript.onload = function() {
        console.log('Jitsi API loaded');
        
        const api = new JitsiMeetExternalAPI(jitsiDomain, options);
        
        // Listen for conference events
        api.addEventListener('videoConferenceLeft', function() {
            console.log('Call ended - redirecting to dashboard');
            setTimeout(redirectToDashboard, 1000);
        });
        
        api.addEventListener('readyToClose', function() {
            console.log('Call ready to close - redirecting to dashboard');
            setTimeout(redirectToDashboard, 500);
        });
    };
    
    function redirectToDashboard() {
        if (isDoctor) {
            window.location.href = "{{ url_for('clinician_dashboard') }}";
        } else {
            window.location.href = "{{ url_for('patient_dashboard') }}";
        }
    }
    
    // Fallback: redirect if user doesn't come back after 2 hours (meeting duration limit)
    setTimeout(function() {
        console.log('Meeting timeout - redirecting');
        redirectToDashboard();
    }, 2 * 60 * 60 * 1000); // 2 hours
</script>

<style>
.video-call-container {
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
}

#jitsi-container {
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f0f0f0;
    min-height: 600px;
}
</style>
{% endblock %}
